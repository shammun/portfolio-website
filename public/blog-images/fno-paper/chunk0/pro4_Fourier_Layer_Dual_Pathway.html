<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fourier Layer - Internal Architecture</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fafbff 0%, #f5f7ff 100%);
      min-height: 100vh;
      padding: 30px 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
    }

    /* Title */
    .title {
      text-align: center;
      margin-bottom: 30px;
    }

    .title h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .title p {
      font-size: 14px;
      color: #64748b;
    }

    /* Main layout - controls on left, diagram on right */
    .main-layout {
      display: flex;
      gap: 25px;
      align-items: flex-start;
    }

    /* Left sidebar with controls */
    .left-sidebar {
      width: 220px;
      flex-shrink: 0;
      position: sticky;
      top: 30px;
    }

    /* Controls card */
    .controls-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
      margin-bottom: 20px;
    }

    .controls-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
    }

    .control-btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .control-btn:last-child {
      margin-bottom: 0;
    }

    .control-btn.primary {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      color: white;
    }

    .control-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.35);
    }

    .control-btn.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .control-btn.secondary {
      background: #f8fafc;
      color: #64748b;
      border: 2px solid #e2e8f0;
    }

    .control-btn.secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    /* Step display in sidebar */
    .step-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
      margin-bottom: 20px;
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a78bfa, #7c3aed);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }

    .step-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .step-text {
      font-size: 14px;
      color: #1e293b;
      line-height: 1.5;
    }

    .step-text strong {
      color: #7c3aed;
    }

    .step-card.idle {
      background: #f8fafc;
    }

    .step-card.idle .step-number {
      background: #e2e8f0;
      color: #64748b;
    }

    .step-card.idle .step-text {
      color: #64748b;
    }

    /* Legend in sidebar */
    .legend-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-line {
      width: 24px;
      height: 4px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .legend-line.local {
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }

    .legend-line.spectral {
      background: linear-gradient(90deg, #818cf8, #7c3aed);
    }

    .legend-line.data {
      background: #94a3b8;
    }

    /* Right content area */
    .right-content {
      flex: 1;
      min-width: 0;
    }

    /* Main diagram container */
    .diagram {
      background: white;
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
      position: relative;
      overflow: hidden;
    }

    /* SVG Diagram */
    .diagram-svg {
      width: 100%;
      height: auto;
    }

    /* Component boxes */
    .component-box {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .component-box:hover .box-bg {
      filter: brightness(1.03);
    }

    .component-box:hover .box-border {
      stroke-width: 3;
    }

    /* Active/highlighted state */
    .component-box.active .box-bg {
      filter: brightness(1.05);
    }

    .component-box.active .box-border {
      stroke-width: 4;
      stroke-dasharray: none;
    }

    .component-box.active .glow-ring {
      opacity: 1;
    }

    .glow-ring {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* Pathway labels */
    .pathway-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* Arrow animations */
    .arrow-path {
      transition: all 0.3s ease;
    }

    .arrow-path.active {
      stroke-width: 5;
      filter: drop-shadow(0 0 6px currentColor);
    }

    /* Info panels */
    .info-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .info-panel.active {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .info-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .info-panel-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .info-panel-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .info-panel-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Georgia, serif;
      font-size: 24px;
      font-weight: 600;
    }

    .info-panel-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
    }

    .info-panel-subtitle {
      font-size: 13px;
      color: #64748b;
    }

    .info-panel-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      border: none;
      background: #f1f5f9;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      color: #64748b;
      transition: all 0.2s ease;
    }

    .info-panel-close:hover {
      background: #e2e8f0;
      color: #1e293b;
    }

    .info-panel-content {
      font-size: 14px;
      line-height: 1.7;
      color: #475569;
    }

    .info-panel-content p {
      margin-bottom: 12px;
    }

    .info-panel-content ul {
      margin: 12px 0 12px 20px;
    }

    .info-panel-content li {
      margin-bottom: 8px;
    }

    .info-panel-content code {
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 13px;
      color: #7c3aed;
    }

    .info-panel-math {
      background: #f8fafc;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin: 15px 0;
      font-family: Georgia, serif;
      font-size: 16px;
      color: #1e293b;
    }

    /* Color classes for info panels */
    .info-input .info-panel-icon {
      background: #fff7ed;
      color: #ea580c;
    }

    .info-local .info-panel-icon {
      background: #fef3c7;
      color: #d97706;
    }

    .info-fft .info-panel-icon {
      background: #dbeafe;
      color: #2563eb;
    }

    .info-weights .info-panel-icon {
      background: #ede9fe;
      color: #7c3aed;
    }

    .info-ifft .info-panel-icon {
      background: #dbeafe;
      color: #2563eb;
    }

    .info-add .info-panel-icon {
      background: #f1f5f9;
      color: #64748b;
    }

    .info-activation .info-panel-icon {
      background: #fce7f3;
      color: #db2777;
    }

    .info-output .info-panel-icon {
      background: #ecfdf5;
      color: #059669;
    }

    /* Equation display */
    .equation-box {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 20px 30px;
      margin-top: 25px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }

    .equation-label {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .equation {
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1e293b;
      line-height: 1.6;
    }

    .equation .subscript {
      font-size: 14px;
      vertical-align: sub;
    }

    .equation .highlight-local {
      color: #d97706;
      font-weight: 600;
    }

    .equation .highlight-spectral {
      color: #7c3aed;
      font-weight: 600;
    }

    .equation .highlight-activation {
      color: #db2777;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }

      .left-sidebar {
        width: 100%;
        position: static;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .left-sidebar>* {
        flex: 1;
        min-width: 200px;
      }

      .diagram {
        padding: 20px;
      }

      .equation {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="title">
      <h1>Inside a Fourier Layer</h1>
      <p>Click on any component to learn more • Press "Step Through" to see data flow</p>
    </div>

    <div class="main-layout">
      <!-- Left Sidebar with Controls -->
      <div class="left-sidebar">
        <!-- Controls -->
        <div class="controls-card">
          <div class="controls-title">Controls</div>
          <button class="control-btn primary" id="step-btn" onclick="stepThrough()">
            <span>▶</span> Step Through
          </button>
          <button class="control-btn secondary" onclick="resetAnimation()">
            <span>↺</span> Reset
          </button>
        </div>

        <!-- Step Display -->
        <div class="step-card idle" id="step-card">
          <div class="step-header">
            <div class="step-number" id="step-number">—</div>
            <div class="step-label">Current Step</div>
          </div>
          <div class="step-text" id="step-text">Click "Step Through" to see how data flows through the Fourier Layer
          </div>
        </div>

        <!-- Legend -->
        <div class="legend-card">
          <div class="controls-title">Legend</div>
          <div class="legend-item">
            <div class="legend-line local"></div>
            <span>Local Path (W)</span>
          </div>
          <div class="legend-item">
            <div class="legend-line spectral"></div>
            <span>Spectral Path (ℱ → R → ℱ⁻¹)</span>
          </div>
          <div class="legend-item">
            <div class="legend-line data"></div>
            <span>Data Flow</span>
          </div>
        </div>
      </div>

      <!-- Right Content - Diagram -->
      <div class="right-content">
        <div class="diagram">
          <svg class="diagram-svg" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <!-- Gradients -->
              <linearGradient id="inputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fff7ed" />
                <stop offset="100%" style="stop-color:#ffedd5" />
              </linearGradient>
              <linearGradient id="localGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fef3c7" />
                <stop offset="100%" style="stop-color:#fde68a" />
              </linearGradient>
              <linearGradient id="fftGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#dbeafe" />
                <stop offset="100%" style="stop-color:#bfdbfe" />
              </linearGradient>
              <linearGradient id="weightsGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ede9fe" />
                <stop offset="100%" style="stop-color:#ddd6fe" />
              </linearGradient>
              <linearGradient id="activationGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fce7f3" />
                <stop offset="100%" style="stop-color:#fbcfe8" />
              </linearGradient>
              <linearGradient id="outputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ecfdf5" />
                <stop offset="100%" style="stop-color:#d1fae5" />
              </linearGradient>

              <!-- Shadows -->
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#6366f1" flood-opacity="0.12" />
              </filter>
              <filter id="glowOrange" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="8" result="blur" />
                <feFlood flood-color="#f59e0b" flood-opacity="0.4" />
                <feComposite in2="blur" operator="in" />
                <feMerge>
                  <feMergeNode />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
              <filter id="glowPurple" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="8" result="blur" />
                <feFlood flood-color="#7c3aed" flood-opacity="0.4" />
                <feComposite in2="blur" operator="in" />
                <feMerge>
                  <feMergeNode />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
              <filter id="glowPink" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="8" result="blur" />
                <feFlood flood-color="#db2777" flood-opacity="0.4" />
                <feComposite in2="blur" operator="in" />
                <feMerge>
                  <feMergeNode />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
              <filter id="glowGreen" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="8" result="blur" />
                <feFlood flood-color="#10b981" flood-opacity="0.4" />
                <feComposite in2="blur" operator="in" />
                <feMerge>
                  <feMergeNode />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>

              <!-- Arrow markers -->
              <marker id="arrowGray" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 L2,5 Z" fill="#94a3b8" />
              </marker>
              <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 L2,5 Z" fill="#f59e0b" />
              </marker>
              <marker id="arrowPurple" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 L2,5 Z" fill="#7c3aed" />
              </marker>
            </defs>

            <!-- Background pathway indicators -->
            <rect x="170" y="55" width="580" height="95" rx="16" fill="#fffbeb" opacity="0.5" />
            <rect x="170" y="260" width="580" height="130" rx="16" fill="#eef2ff" opacity="0.5" />

            <!-- Pathway labels -->
            <text x="185" y="78" class="pathway-label" fill="#b45309">LOCAL PATHWAY (bypass connection)</text>
            <text x="185" y="283" class="pathway-label" fill="#6366f1">SPECTRAL PATHWAY (Fourier convolution)</text>

            <!-- ============ ARROWS (drawn first, behind boxes) ============ -->

            <!-- Input to split -->
            <path id="arrow-input" class="arrow-path" d="M145,205 L175,205" stroke="#94a3b8" stroke-width="3"
              fill="none" marker-end="url(#arrowGray)" />

            <!-- Split to local path -->
            <path id="arrow-split-local" class="arrow-path" d="M195,205 L195,105 L250,105" stroke="#f59e0b"
              stroke-width="3" fill="none" marker-end="url(#arrowOrange)" />

            <!-- Split to spectral path -->
            <path id="arrow-split-spectral" class="arrow-path" d="M195,205 L195,325 L220,325" stroke="#7c3aed"
              stroke-width="3" fill="none" marker-end="url(#arrowPurple)" />

            <!-- Local W to merge -->
            <path id="arrow-local-merge" class="arrow-path" d="M410,105 L760,105 L760,180" stroke="#f59e0b"
              stroke-width="3" fill="none" marker-end="url(#arrowOrange)" />

            <!-- FFT to R -->
            <path id="arrow-fft-r" class="arrow-path" d="M340,325 L390,325" stroke="#7c3aed" stroke-width="3"
              fill="none" marker-end="url(#arrowPurple)" />

            <!-- R to iFFT -->
            <path id="arrow-r-ifft" class="arrow-path" d="M530,325 L580,325" stroke="#7c3aed" stroke-width="3"
              fill="none" marker-end="url(#arrowPurple)" />

            <!-- iFFT to merge -->
            <path id="arrow-ifft-merge" class="arrow-path" d="M700,325 L760,325 L760,250" stroke="#7c3aed"
              stroke-width="3" fill="none" marker-end="url(#arrowPurple)" />

            <!-- Merge to activation -->
            <path id="arrow-merge-act" class="arrow-path" d="M790,215 L830,215" stroke="#94a3b8" stroke-width="3"
              fill="none" marker-end="url(#arrowGray)" />

            <!-- Activation to output -->
            <path id="arrow-act-output" class="arrow-path" d="M910,215 L950,215" stroke="#94a3b8" stroke-width="3"
              fill="none" marker-end="url(#arrowGray)" />

            <!-- ============ INPUT ============ -->
            <g class="component-box" id="comp-input" data-info="input" transform="translate(30, 160)">
              <rect class="glow-ring" x="-8" y="-8" width="126" height="106" rx="18" fill="none" stroke="#f97316"
                stroke-width="4" opacity="0" filter="url(#glowOrange)" />
              <rect class="box-bg" x="0" y="0" width="110" height="90" rx="14" fill="url(#inputGrad)" />
              <rect class="box-border" x="0" y="0" width="110" height="90" rx="14" fill="none" stroke="#fdba74"
                stroke-width="2" />
              <text x="55" y="25" text-anchor="middle" font-size="10" font-weight="600" fill="#64748b"
                letter-spacing="0.5">INPUT</text>
              <text x="55" y="50" text-anchor="middle" font-family="Georgia, serif" font-size="20" font-style="italic"
                fill="#ea580c">v<tspan font-size="12" baseline-shift="sub">l</tspan>(x)</text>
              <!-- Mini signal -->
              <path d="M20,70 Q35,55 50,70 Q65,85 80,70 Q90,60 95,70" stroke="#f97316" stroke-width="2" fill="none" />
            </g>

            <!-- ============ SPLIT POINT ============ -->
            <g id="comp-split">
              <circle cx="195" cy="205" r="10" fill="white" stroke="#94a3b8" stroke-width="2" />
              <text x="195" y="210" text-anchor="middle" font-size="14" font-weight="600" fill="#64748b">⋮</text>
            </g>

            <!-- ============ LOCAL PATH: W ============ -->
            <g class="component-box" id="comp-local" data-info="local" transform="translate(255, 65)">
              <rect class="glow-ring" x="-8" y="-8" width="166" height="96" rx="18" fill="none" stroke="#f59e0b"
                stroke-width="4" opacity="0" filter="url(#glowOrange)" />
              <rect class="box-bg" x="0" y="0" width="150" height="80" rx="14" fill="url(#localGrad)" />
              <rect class="box-border" x="0" y="0" width="150" height="80" rx="14" fill="none" stroke="#fbbf24"
                stroke-width="2" />
              <text x="75" y="32" text-anchor="middle" font-family="Georgia, serif" font-size="28" font-weight="600"
                fill="#b45309">W</text>
              <text x="75" y="52" text-anchor="middle" font-size="10" fill="#92400e">Local Linear</text>
              <text x="75" y="66" text-anchor="middle" font-size="9" fill="#a16207">(1×1 conv)</text>
            </g>

            <!-- ============ SPECTRAL PATH ============ -->

            <!-- FFT Box -->
            <g class="component-box" id="comp-fft" data-info="fft" transform="translate(225, 285)">
              <rect class="glow-ring" x="-8" y="-8" width="126" height="96" rx="18" fill="none" stroke="#3b82f6"
                stroke-width="4" opacity="0" filter="url(#glowPurple)" />
              <rect class="box-bg" x="0" y="0" width="110" height="80" rx="14" fill="url(#fftGrad)" />
              <rect class="box-border" x="0" y="0" width="110" height="80" rx="14" fill="none" stroke="#60a5fa"
                stroke-width="2" />
              <text x="55" y="32" text-anchor="middle" font-family="Georgia, serif" font-size="24" font-weight="600"
                fill="#1e40af">ℱ</text>
              <text x="55" y="50" text-anchor="middle" font-size="11" font-weight="600" fill="#2563eb">FFT</text>
              <text x="55" y="66" text-anchor="middle" font-size="9" fill="#3b82f6">→ Frequency</text>
            </g>

            <!-- R_l Weights Box -->
            <g class="component-box" id="comp-weights" data-info="weights" transform="translate(395, 285)">
              <rect class="glow-ring" x="-8" y="-8" width="146" height="96" rx="18" fill="none" stroke="#7c3aed"
                stroke-width="4" opacity="0" filter="url(#glowPurple)" />
              <rect class="box-bg" x="0" y="0" width="130" height="80" rx="14" fill="url(#weightsGrad)" />
              <rect class="box-border" x="0" y="0" width="130" height="80" rx="14" fill="none" stroke="#a78bfa"
                stroke-width="2" />
              <text x="65" y="32" text-anchor="middle" font-family="Georgia, serif" font-size="24" font-weight="600"
                fill="#5b21b6">R<tspan font-size="14" baseline-shift="sub">l</tspan></text>
              <text x="65" y="52" text-anchor="middle" font-size="10" fill="#6d28d9">Learnable Weights</text>
              <text x="65" y="66" text-anchor="middle" font-size="9" fill="#7c3aed">(in Fourier space)</text>
            </g>

            <!-- iFFT Box -->
            <g class="component-box" id="comp-ifft" data-info="ifft" transform="translate(585, 285)">
              <rect class="glow-ring" x="-8" y="-8" width="126" height="96" rx="18" fill="none" stroke="#3b82f6"
                stroke-width="4" opacity="0" filter="url(#glowPurple)" />
              <rect class="box-bg" x="0" y="0" width="110" height="80" rx="14" fill="url(#fftGrad)" />
              <rect class="box-border" x="0" y="0" width="110" height="80" rx="14" fill="none" stroke="#60a5fa"
                stroke-width="2" />
              <text x="55" y="32" text-anchor="middle" font-family="Georgia, serif" font-size="20" font-weight="600"
                fill="#1e40af">ℱ<tspan font-size="12" baseline-shift="super">-1</tspan></text>
              <text x="55" y="50" text-anchor="middle" font-size="11" font-weight="600" fill="#2563eb">iFFT</text>
              <text x="55" y="66" text-anchor="middle" font-size="9" fill="#3b82f6">→ Spatial</text>
            </g>

            <!-- ============ MERGE POINT (+) ============ -->
            <g class="component-box" id="comp-add" data-info="add" transform="translate(735, 190)">
              <rect class="glow-ring" x="-8" y="-8" width="66" height="66" rx="33" fill="none" stroke="#64748b"
                stroke-width="4" opacity="0" />
              <circle class="box-bg" cx="25" cy="25" r="25" fill="white" />
              <circle class="box-border" cx="25" cy="25" r="25" fill="none" stroke="#94a3b8" stroke-width="2" />
              <text x="25" y="33" text-anchor="middle" font-size="28" font-weight="600" fill="#64748b">+</text>
            </g>

            <!-- ============ ACTIVATION ============ -->
            <g class="component-box" id="comp-activation" data-info="activation" transform="translate(835, 175)">
              <rect class="glow-ring" x="-8" y="-8" width="86" height="96" rx="18" fill="none" stroke="#db2777"
                stroke-width="4" opacity="0" filter="url(#glowPink)" />
              <rect class="box-bg" x="0" y="0" width="70" height="80" rx="14" fill="url(#activationGrad)" />
              <rect class="box-border" x="0" y="0" width="70" height="80" rx="14" fill="none" stroke="#f472b6"
                stroke-width="2" />
              <text x="35" y="35" text-anchor="middle" font-family="Georgia, serif" font-size="28" font-style="italic"
                fill="#be185d">σ</text>
              <text x="35" y="55" text-anchor="middle" font-size="9" fill="#db2777">GELU</text>
              <text x="35" y="68" text-anchor="middle" font-size="8" fill="#ec4899">Activation</text>
            </g>

            <!-- ============ OUTPUT ============ -->
            <g class="component-box" id="comp-output" data-info="output" transform="translate(870, 400)">
              <rect class="glow-ring" x="-8" y="-8" width="126" height="86" rx="18" fill="none" stroke="#10b981"
                stroke-width="4" opacity="0" filter="url(#glowGreen)" />
              <rect class="box-bg" x="0" y="0" width="110" height="70" rx="14" fill="url(#outputGrad)" />
              <rect class="box-border" x="0" y="0" width="110" height="70" rx="14" fill="none" stroke="#34d399"
                stroke-width="2" />
              <text x="55" y="22" text-anchor="middle" font-size="10" font-weight="600" fill="#64748b"
                letter-spacing="0.5">OUTPUT</text>
              <text x="55" y="48" text-anchor="middle" font-family="Georgia, serif" font-size="18" font-style="italic"
                fill="#059669">v<tspan font-size="11" baseline-shift="sub">l+1</tspan>(x)</text>
            </g>

            <!-- Arrow from activation to output -->
            <path id="arrow-final" class="arrow-path" d="M890,260 L890,395" stroke="#94a3b8" stroke-width="3"
              fill="none" marker-end="url(#arrowGray)" />
          </svg>
        </div>

        <!-- Equation -->
        <div class="equation-box">
          <div class="equation-label">FOURIER LAYER EQUATION</div>
          <div class="equation">
            v<span class="subscript">l+1</span>(x) =
            <span class="highlight-activation">σ</span>(
            <span class="highlight-local">W · v<span class="subscript">l</span>(x)</span> +
            <span class="highlight-spectral">ℱ<sup>-1</sup>( R<span class="subscript">l</span> · ℱ(v<span
                class="subscript">l</span>) )(x)</span>
            )
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Panel Overlay -->
  <div class="info-panel-overlay" onclick="closeInfoPanel()"></div>

  <!-- Info Panels -->
  <div class="info-panel info-input" id="panel-input">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">v<sub>l</sub></div>
      <div>
        <div class="info-panel-title">Input: v<sub>l</sub>(x)</div>
        <div class="info-panel-subtitle">Layer Input Function</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The input to this Fourier layer is a function <strong>v<sub>l</sub>(x)</strong> defined on the spatial domain.
      </p>
      <ul>
        <li><strong>Shape:</strong> (batch, height, width, channels)</li>
        <li>Represents the hidden state from the previous layer</li>
        <li>For the first Fourier layer, this comes from the Lifting Layer</li>
      </ul>
      <p>The function is discretized on a grid, but FNO can handle different resolutions!</p>
    </div>
  </div>

  <div class="info-panel info-local" id="panel-local">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">W</div>
      <div>
        <div class="info-panel-title">Local Linear Transform</div>
        <div class="info-panel-subtitle">Pointwise 1×1 Convolution</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The local pathway applies a <strong>pointwise linear transformation</strong> (1×1 convolution).</p>
      <div class="info-panel-math">W · v<sub>l</sub>(x)</div>
      <ul>
        <li>Acts independently at each spatial location</li>
        <li>Mixes information across channels</li>
        <li>Provides a "bypass connection" for local information</li>
        <li>Computationally cheap but important for stability</li>
      </ul>
      <p><strong>Code:</strong> <code>nn.Conv2d(width, width, kernel_size=1)</code></p>
    </div>
  </div>

  <div class="info-panel info-fft" id="panel-fft">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">ℱ</div>
      <div>
        <div class="info-panel-title">FFT - Fourier Transform</div>
        <div class="info-panel-subtitle">Spatial → Frequency Domain</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The <strong>Fast Fourier Transform</strong> converts the spatial signal into frequency components.</p>
      <div class="info-panel-math">ℱ(v<sub>l</sub>) = V̂<sub>l</sub>(k)</div>
      <ul>
        <li>Transforms from (x, y) space to (k<sub>x</sub>, k<sub>y</sub>) frequency space</li>
        <li>Low frequencies = smooth, large-scale patterns</li>
        <li>High frequencies = sharp details, edges</li>
        <li>Complexity: O(n log n) using FFT algorithm</li>
      </ul>
      <p><strong>Code:</strong> <code>torch.fft.rfft2(x, norm="ortho")</code></p>
    </div>
  </div>

  <div class="info-panel info-weights" id="panel-weights">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">R<sub>l</sub></div>
      <div>
        <div class="info-panel-title">Learnable Fourier Weights</div>
        <div class="info-panel-subtitle">Spectral Convolution Kernel</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The <strong>key innovation</strong> of FNO: learnable weights in Fourier space!</p>
      <div class="info-panel-math">R<sub>l</sub> · ℱ(v<sub>l</sub>)</div>
      <ul>
        <li><strong>R<sub>l</sub></strong> is a complex-valued weight tensor</li>
        <li>Only keeps the first k<sub>max</sub> modes (typically 12-20)</li>
        <li>Higher modes (noise) are truncated to zero</li>
        <li>Equivalent to global convolution in spatial domain!</li>
      </ul>
      <p><strong>Shape:</strong> <code>(width, width, k_max, k_max, 2)</code></p>
    </div>
  </div>

  <div class="info-panel info-ifft" id="panel-ifft">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">ℱ<sup>-1</sup></div>
      <div>
        <div class="info-panel-title">iFFT - Inverse Transform</div>
        <div class="info-panel-subtitle">Frequency → Spatial Domain</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The <strong>Inverse FFT</strong> transforms back to spatial domain.</p>
      <div class="info-panel-math">ℱ<sup>-1</sup>(R<sub>l</sub> · V̂<sub>l</sub>)(x)</div>
      <ul>
        <li>Converts frequency coefficients back to spatial signal</li>
        <li>The result has the same spatial resolution as input</li>
        <li>Completes the "spectral convolution" operation</li>
      </ul>
      <p><strong>Key insight:</strong> Multiplication in frequency domain = convolution in spatial domain!</p>
      <p><strong>Code:</strong> <code>torch.fft.irfft2(x, norm="ortho")</code></p>
    </div>
  </div>

  <div class="info-panel info-add" id="panel-add">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">+</div>
      <div>
        <div class="info-panel-title">Residual Addition</div>
        <div class="info-panel-subtitle">Combining Both Pathways</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The two pathways are <strong>added together</strong> element-wise:</p>
      <div class="info-panel-math">W · v<sub>l</sub>(x) + ℱ<sup>-1</sup>(R<sub>l</sub> · ℱ(v<sub>l</sub>))(x)</div>
      <ul>
        <li><strong>Local path (W):</strong> Captures pointwise transformations</li>
        <li><strong>Spectral path:</strong> Captures global dependencies</li>
        <li>Together they model both local and global PDE dynamics</li>
      </ul>
      <p>This is similar to a residual connection in ResNets!</p>
    </div>
  </div>

  <div class="info-panel info-activation" id="panel-activation">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">σ</div>
      <div>
        <div class="info-panel-title">Nonlinear Activation</div>
        <div class="info-panel-subtitle">GELU Activation Function</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>A <strong>nonlinear activation</strong> is applied after combining the pathways.</p>
      <div class="info-panel-math">σ(z) = z · Φ(z)</div>
      <ul>
        <li><strong>GELU</strong> (Gaussian Error Linear Unit) is commonly used</li>
        <li>Smooth alternative to ReLU</li>
        <li>Applied pointwise in spatial domain</li>
        <li>Enables learning complex nonlinear mappings</li>
      </ul>
      <p><strong>Note:</strong> The final Fourier layer often omits activation!</p>
      <p><strong>Code:</strong> <code>F.gelu(x)</code></p>
    </div>
  </div>

  <div class="info-panel info-output" id="panel-output">
    <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    <div class="info-panel-header">
      <div class="info-panel-icon">v<sub>l+1</sub></div>
      <div>
        <div class="info-panel-title">Output: v<sub>l+1</sub>(x)</div>
        <div class="info-panel-subtitle">Layer Output Function</div>
      </div>
    </div>
    <div class="info-panel-content">
      <p>The output <strong>v<sub>l+1</sub>(x)</strong> is the transformed function.</p>
      <div class="info-panel-math">v<sub>l+1</sub>(x) = σ(W · v<sub>l</sub>(x) + K(v<sub>l</sub>)(x))</div>
      <ul>
        <li>Same spatial shape as input</li>
        <li>Contains both local and global information</li>
        <li>Passed to the next Fourier layer (or Projection layer)</li>
      </ul>
      <p>After L layers, the representation captures the full PDE solution!</p>
    </div>
  </div>

  <script>
    // Component click handlers
    document.querySelectorAll('.component-box').forEach(box => {
      box.addEventListener('click', function (e) {
        e.stopPropagation();
        const infoType = this.dataset.info;
        if (infoType) {
          openInfoPanel(infoType);
        }
      });
    });

    function openInfoPanel(type) {
      closeInfoPanel();
      const panel = document.getElementById(`panel-${type}`);
      const overlay = document.querySelector('.info-panel-overlay');
      if (panel) {
        panel.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function closeInfoPanel() {
      document.querySelectorAll('.info-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.querySelector('.info-panel-overlay').classList.remove('active');
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeInfoPanel();
    });

    // Step through animation
    let currentStep = 0;
    let isAnimating = false;

    const steps = [
      {
        components: ['comp-input'],
        arrows: [],
        text: '<strong>Input v<sub>l</sub>(x)</strong> enters the Fourier Layer'
      },
      {
        components: ['comp-input'],
        arrows: ['arrow-input', 'arrow-split-local', 'arrow-split-spectral'],
        text: 'Data <strong>splits</strong> into two parallel pathways'
      },
      {
        components: ['comp-local'],
        arrows: ['arrow-split-local'],
        text: '<strong>Local pathway:</strong> Apply pointwise linear transform W'
      },
      {
        components: ['comp-fft'],
        arrows: ['arrow-split-spectral'],
        text: '<strong>Spectral pathway:</strong> FFT transforms to frequency domain'
      },
      {
        components: ['comp-weights'],
        arrows: ['arrow-fft-r'],
        text: 'Multiply with <strong>learnable weights R<sub>l</sub></strong> in Fourier space'
      },
      {
        components: ['comp-ifft'],
        arrows: ['arrow-r-ifft'],
        text: '<strong>iFFT</strong> transforms back to spatial domain'
      },
      {
        components: ['comp-add'],
        arrows: ['arrow-local-merge', 'arrow-ifft-merge'],
        text: 'Both pathways <strong>combine</strong> via addition (+)'
      },
      {
        components: ['comp-activation'],
        arrows: ['arrow-merge-act'],
        text: 'Apply <strong>nonlinear activation σ</strong> (GELU)'
      },
      {
        components: ['comp-output'],
        arrows: ['arrow-final'],
        text: '<strong>Output v<sub>l+1</sub>(x)</strong> — ready for next layer!'
      }
    ];

    function stepThrough() {
      if (isAnimating) return;

      currentStep++;
      if (currentStep > steps.length) {
        resetAnimation();
        return;
      }

      const step = steps[currentStep - 1];
      const stepCard = document.getElementById('step-card');
      const stepNumber = document.getElementById('step-number');
      const stepText = document.getElementById('step-text');

      // Clear previous highlights
      document.querySelectorAll('.component-box').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.arrow-path').forEach(a => a.classList.remove('active'));

      // Highlight current components
      step.components.forEach(id => {
        const comp = document.getElementById(id);
        if (comp) comp.classList.add('active');
      });

      // Highlight current arrows
      step.arrows.forEach(id => {
        const arrow = document.getElementById(id);
        if (arrow) arrow.classList.add('active');
      });

      // Update step display
      stepCard.classList.remove('idle');
      stepNumber.textContent = currentStep;
      stepText.innerHTML = step.text;

      // Update button text
      const btn = document.getElementById('step-btn');
      if (currentStep >= steps.length) {
        btn.innerHTML = '<span>↺</span> Start Over';
      } else {
        btn.innerHTML = '<span>▶</span> Next Step';
      }
    }

    function resetAnimation() {
      currentStep = 0;

      // Clear all highlights
      document.querySelectorAll('.component-box').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.arrow-path').forEach(a => a.classList.remove('active'));

      // Reset step display
      const stepCard = document.getElementById('step-card');
      const stepNumber = document.getElementById('step-number');
      const stepText = document.getElementById('step-text');

      stepCard.classList.add('idle');
      stepNumber.textContent = '—';
      stepText.textContent = 'Click "Step Through" to see how data flows through the Fourier Layer';

      // Reset button
      document.getElementById('step-btn').innerHTML = '<span>▶</span> Step Through';
    }
  </script>
</body>

</html>