<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyTorch Dataset & DataLoader Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fafbff 0%, #f5f7ff 100%);
            color: #1e293b;
        }

        .mono {
            font-family: 'Fira Code', monospace;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
            border: 1px solid #eef2ff;
        }

        .index-box {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .index-box.selected {
            background-color: #14b8a6;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(20, 184, 166, 0.2);
            border-color: #0d9488;
        }

        .shuffle-item {
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .batch-bracket {
            border-left: 2px solid #ddd6fe;
            border-right: 2px solid #ddd6fe;
            border-bottom: 2px solid #ddd6fe;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .corpus-token {
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .corpus-token.active-input {
            background-color: #ccfbf1 !important;
            border-color: #2dd4bf;
            color: #0f766e;
            font-weight: 600;
        }

        .corpus-token.active-target {
            background-color: #ffedd5 !important;
            border-color: #fb923c;
            color: #9a3412;
            font-weight: 600;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight sm:text-4xl">
                PyTorch Data Pipeline
            </h1>
            <p class="text-slate-500 max-w-2xl mx-auto">
                Understanding how raw data becomes training batches through the Dataset and DataLoader classes.
            </p>
        </header>

        <div class="grid lg:grid-cols-12 gap-8">
            <!-- Left: Visualizations -->
            <div class="lg:col-span-7 space-y-8">

                <!-- STEP 0: TEXT INPUT -->
                <section class="card p-6 border-2 border-indigo-100 bg-indigo-50/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-indigo-100 rounded-lg">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-indigo-900">Step 0: Custom Source Text</h2>
                    </div>
                    <div class="space-y-4">
                        <textarea id="custom-text-input" rows="3"
                            class="w-full p-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm outline-none transition-all"
                            placeholder="Enter text here to generate a new dataset..."></textarea>
                        <button id="update-text-btn"
                            class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors text-sm shadow-md">
                            TOKENIZE & LOAD DATASET
                        </button>
                    </div>
                </section>

                <!-- PART 1: DATASET -->
                <section class="card p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-teal-50 rounded-lg">
                            <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3zm0 5h16m-16 4h16M4 8h16">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold">1. The Dataset</h2>
                    </div>

                    <div class="space-y-6">
                        <!-- Raw Dataset Content Visual -->
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Raw Dataset
                                Content (Source Corpus with IDs)</p>
                            <div id="corpus-display" class="flex flex-wrap gap-1 items-start content-start">
                                <!-- Tokens generated by JS -->
                            </div>
                        </div>

                        <div>
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-widest mb-3">Storage
                                (Click an index to call __getitem__)</p>
                            <div id="index-grid" class="flex flex-wrap gap-2">
                                <!-- Indices generated by JS -->
                            </div>
                        </div>

                        <div id="sample-display" class="space-y-3 opacity-0 transition-opacity duration-300">
                            <div class="flex items-center gap-2 text-indigo-600 font-bold mono text-sm mb-1">
                                <span class="bg-indigo-50 px-2 py-1 rounded">dataset[<span
                                        id="display-idx">0</span>]</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                </svg>
                            </div>

                            <div class="grid sm:grid-cols-2 gap-3">
                                <div class="p-3 bg-teal-50 rounded-xl border border-teal-100">
                                    <div class="flex justify-between items-start mb-1">
                                        <p class="text-[10px] font-bold text-teal-600 uppercase">Input (x)</p>
                                        <span id="display-input-text"
                                            class="text-[9px] text-teal-500 font-bold italic"></span>
                                    </div>
                                    <div id="display-input" class="mono text-sm text-teal-800 tracking-wider"></div>
                                </div>
                                <div class="p-3 bg-orange-50 rounded-xl border border-orange-100">
                                    <div class="flex justify-between items-start mb-1">
                                        <p class="text-[10px] font-bold text-orange-600 uppercase">Target (y)</p>
                                        <span id="display-target-text"
                                            class="text-[9px] text-orange-500 font-bold italic"></span>
                                    </div>
                                    <div id="display-target" class="mono text-sm text-orange-800 tracking-wider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PART 2: DATALOADER -->
                <section class="card p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-purple-50 rounded-lg">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold">2. The DataLoader</h2>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl space-y-6 mb-8">
                        <div class="grid sm:grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Batch Size</label>
                                    <span id="batch-size-label" class="text-xs font-bold text-purple-600 mono">4</span>
                                </div>
                                <input id="batch-size-slider" type="range" min="1" max="8" value="4"
                                    class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div
                                class="flex items-center justify-between bg-white px-4 py-2 rounded-lg border border-slate-200">
                                <span class="text-xs font-bold text-slate-500 uppercase">Shuffle</span>
                                <button id="shuffle-toggle"
                                    class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors focus:outline-none">
                                    <span
                                        class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
                                        id="shuffle-dot"></span>
                                </button>
                            </div>
                        </div>
                        <button id="generate-btn"
                            class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z">
                                </path>
                            </svg>
                            GENERATE BATCHES
                        </button>
                    </div>

                    <div id="loader-visuals" class="space-y-8">
                        <!-- Shuffled list -->
                        <div class="space-y-2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">
                                Fetching Indices</p>
                            <div id="shuffle-container" class="flex justify-between px-2 h-10">
                                <!-- Generated indices -->
                            </div>
                            <div id="bracket-container" class="flex justify-between px-2 h-4">
                                <!-- Generated brackets -->
                            </div>
                        </div>

                        <!-- Batch Cards -->
                        <div id="batch-cards" class="space-y-4">
                            <!-- Generated batches -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right: Code Snippets -->
            <div class="lg:col-span-5 space-y-6">
                <div class="sticky top-8 space-y-6">
                    <div class="card p-5 bg-slate-900 border-slate-800">
                        <div class="flex items-center gap-2 mb-4 text-slate-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-xs font-bold uppercase tracking-wider">Dataset Implementation</span>
                        </div>
                        <pre class="code-block mono leading-relaxed"><code class="text-blue-400">class</code> <code class="text-yellow-400">GPTDataset</code>(<code class="text-green-400">Dataset</code>):
    <code class="text-blue-400">def</code> <code class="text-yellow-400">__init__</code>(self, txt, tokenizer):
        self.input_ids = []
        self.target_ids = []
        <code class="text-slate-500"># Sliding window logic...</code>

    <code class="text-blue-400">def</code> <code class="text-yellow-400">__len__</code>(self):
        <code class="text-blue-400">return</code> <code class="text-purple-400">len</code>(self.input_ids)

    <code class="text-blue-400">def</code> <code class="text-yellow-400">__getitem__</code>(self, idx):
        <code class="text-blue-400">return</code> self.input_ids[idx], self.target_ids[idx]</pre>
                    </div>

                    <div class="card p-5 bg-slate-900 border-slate-800">
                        <div class="flex items-center gap-2 mb-4 text-slate-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-xs font-bold uppercase tracking-wider">DataLoader Usage</span>
                        </div>
                        <pre
                            class="code-block mono leading-relaxed">dataloader = <code class="text-green-400">DataLoader</code>(
    dataset,
    batch_size=<code class="text-purple-400" id="code-bs">4</code>,
    shuffle=<code class="text-purple-400" id="code-shuffle">False</code>,
    drop_last=<code class="text-purple-400">True</code>
)

<code class="text-slate-500"># The training loop calls this:</code>
inputs, targets = <code class="text-purple-400">next</code>(<code class="text-purple-400">iter</code>(dataloader))</pre>
                    </div>

                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex gap-3">
                        <svg class="w-5 h-5 text-indigo-500 shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-[11px] text-indigo-900 leading-relaxed">
                            <strong>Note:</strong> The Dataset defines <em>what</em> to fetch (one sample), while the
                            DataLoader defines <em>how</em> to fetch it (order, grouping, parallelization).
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let SAMPLES = [];
        let VOCAB = {};
        let CORPUS_TOKENS = [];
        let batchSize = 4;
        let shuffle = false;
        let selectedIdx = null;

        // --- Elements ---
        const indexGrid = document.getElementById('index-grid');
        const shuffleContainer = document.getElementById('shuffle-container');
        const bracketContainer = document.getElementById('bracket-container');
        const batchCards = document.getElementById('batch-cards');
        const sampleDisplay = document.getElementById('sample-display');
        const shuffleToggle = document.getElementById('shuffle-toggle');
        const shuffleDot = document.getElementById('shuffle-dot');
        const bsSlider = document.getElementById('batch-size-slider');
        const bsLabel = document.getElementById('batch-size-label');
        const codeBS = document.getElementById('code-bs');
        const codeShuffle = document.getElementById('code-shuffle');
        const corpusDisplay = document.getElementById('corpus-display');
        const textInput = document.getElementById('custom-text-input');
        const updateTextBtn = document.getElementById('update-text-btn');

        // --- Core Logic ---
        function tokenizeAndLoad(text) {
            // Basic cleaning: remove extra whitespace and split by words/punctuation
            const tokens = text.match(/\w+|[^\w\s]/g) || [];
            if (tokens.length < 5) return false;

            // Reset mapping
            VOCAB = {};
            CORPUS_TOKENS = [];
            SAMPLES = [];

            // Build Vocabulary and convert text to IDs
            let nextId = 100; // Start IDs at 100
            const wordToId = {};

            tokens.forEach(token => {
                if (!(token in wordToId)) {
                    wordToId[token] = nextId++;
                    VOCAB[wordToId[token]] = token;
                }
                CORPUS_TOKENS.push(wordToId[token]);
            });

            // Create Dataset samples using sliding window (Context size 4)
            for (let i = 0; i <= CORPUS_TOKENS.length - 5; i++) {
                SAMPLES.push({
                    idx: i,
                    input: CORPUS_TOKENS.slice(i, i + 4),
                    target: CORPUS_TOKENS.slice(i + 1, i + 5),
                    start: i
                });
            }

            return true;
        }

        function refreshUI() {
            renderCorpus();
            renderIndexGrid();
            clearBatches();
            sampleDisplay.classList.add('opacity-0');
            selectedIdx = null;
        }

        // --- Init ---
        function init() {
            // Set initial text
            const defaultText = "The future of AI is built on data which flows through models to generate new ideas and insights daily in the digital age we see it everywhere around us .";
            textInput.value = defaultText;
            tokenizeAndLoad(defaultText);

            refreshUI();
            updateControls();

            bsSlider.addEventListener('input', (e) => {
                batchSize = parseInt(e.target.value);
                updateControls();
                clearBatches();
            });

            shuffleToggle.addEventListener('click', () => {
                shuffle = !shuffle;
                updateControls();
                clearBatches();
            });

            updateTextBtn.addEventListener('click', () => {
                if (tokenizeAndLoad(textInput.value)) {
                    refreshUI();
                }
            });

            document.getElementById('generate-btn').addEventListener('click', generateBatches);
        }

        function renderCorpus() {
            corpusDisplay.innerHTML = '';
            CORPUS_TOKENS.forEach((id, i) => {
                const div = document.createElement('div');
                div.className = 'corpus-token flex flex-col items-center px-1.5 py-1 rounded-md text-center bg-white border border-slate-100 min-w-[32px] mb-1';
                div.id = `token-${i}`;
                div.innerHTML = `
                    <span class="text-[8px] leading-none text-slate-400 mono font-bold mb-1">${id}</span>
                    <span class="text-xs leading-none whitespace-nowrap text-slate-700">${VOCAB[id] || 'unk'}</span>
                `;
                corpusDisplay.appendChild(div);
            });
        }

        function renderIndexGrid() {
            indexGrid.innerHTML = '';
            SAMPLES.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'w-10 h-10 card flex items-center justify-center font-bold mono text-sm index-box border-2 border-slate-100 hover:border-teal-400';
                btn.innerText = s.idx;
                btn.onclick = () => selectIndex(s.idx);
                indexGrid.appendChild(btn);
            });
        }

        function selectIndex(idx) {
            selectedIdx = idx;
            document.querySelectorAll('.index-box').forEach((box, i) => {
                box.classList.toggle('selected', i === idx);
            });

            const s = SAMPLES[idx];
            document.getElementById('display-idx').innerText = idx;
            document.getElementById('display-input').innerText = `[${s.input.join(', ')}]`;
            document.getElementById('display-target').innerText = `[${s.target.join(', ')}]`;

            // Map IDs to words
            const inputWords = s.input.map(id => VOCAB[id]);
            const targetWords = s.target.map(id => VOCAB[id]);
            document.getElementById('display-input-text').innerText = `"${inputWords.join(' ')}"`;
            document.getElementById('display-target-text').innerText = `"${targetWords.join(' ')}"`;

            // Highlight in corpus
            document.querySelectorAll('.corpus-token').forEach(el => {
                el.classList.remove('active-input', 'active-target');
            });

            // Input highlight
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`token-${s.start + i}`);
                if (el) el.classList.add('active-input');
            }
            // Target highlight
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`token-${s.start + 1 + i}`);
                if (el) el.classList.add('active-target');
            }

            sampleDisplay.classList.remove('opacity-0');
        }

        function updateControls() {
            bsLabel.innerText = batchSize;
            codeBS.innerText = batchSize;
            codeShuffle.innerText = shuffle ? 'True' : 'False';

            shuffleToggle.classList.toggle('bg-indigo-500', shuffle);
            shuffleToggle.classList.toggle('bg-slate-200', !shuffle);
            shuffleDot.classList.toggle('translate-x-6', shuffle);
            shuffleDot.classList.toggle('translate-x-1', !shuffle);
        }

        function clearBatches() {
            shuffleContainer.innerHTML = '';
            bracketContainer.innerHTML = '';
            batchCards.innerHTML = '';
        }

        function generateBatches() {
            clearBatches();

            let indices = Array.from({ length: SAMPLES.length }, (_, i) => i);
            if (shuffle) {
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
            }

            // Render indices
            indices.forEach((idx, i) => {
                const div = document.createElement('div');
                div.className = 'w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded text-xs font-bold mono shadow-sm shuffle-item';
                div.innerText = idx;
                shuffleContainer.appendChild(div);
            });

            // Render brackets and cards
            const numFullBatches = Math.floor(indices.length / batchSize);
            for (let b = 0; b < numFullBatches; b++) {
                const batchIndices = indices.slice(b * batchSize, (b + 1) * batchSize);

                // Bracket
                const bracket = document.createElement('div');
                bracket.className = 'batch-bracket h-full';
                bracket.style.width = `${(batchSize / indices.length) * 100}%`;
                bracketContainer.appendChild(bracket);

                // Card
                const card = document.createElement('div');
                card.className = 'card p-4 border-l-4 border-l-purple-500 animate-in fade-in slide-in-from-bottom-2 duration-300';
                card.style.animationDelay = `${b * 100}ms`;

                const batchData = batchIndices.map(i => SAMPLES[i]);

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-purple-600 uppercase tracking-tighter">Batch ${b} Output</span>
                        <span class="text-[10px] mono text-slate-400">Samples: ${batchIndices.join(', ')}</span>
                    </div>
                    <div class="grid gap-3">
                        <div class="p-2 bg-slate-50 rounded border border-slate-100 overflow-x-auto">
                            <p class="text-[9px] font-bold text-teal-500 uppercase mb-1">X Tensor [${batchSize}, 4]</p>
                            <div class="mono text-[10px] whitespace-pre text-teal-800 leading-tight">${formatTensor(batchData.map(d => d.input))}</div>
                        </div>
                        <div class="p-2 bg-slate-50 rounded border border-slate-100 overflow-x-auto">
                            <p class="text-[9px] font-bold text-orange-500 uppercase mb-1">Y Tensor [${batchSize}, 4]</p>
                            <div class="mono text-[10px] whitespace-pre text-orange-800 leading-tight">${formatTensor(batchData.map(d => d.target))}</div>
                        </div>
                    </div>
                `;
                batchCards.appendChild(card);
            }
        }

        function formatTensor(matrix) {
            return '[\n  ' + matrix.map(row => `[${row.join(', ')}]`).join(',\n  ') + '\n]';
        }

        init();
    </script>
</body>

</html>