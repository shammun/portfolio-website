<!-- OUTPUT PROJECTION INTERACTIVE VISUALIZATION - COMPLETE VERSION -->
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
    <div class="jp-Cell-inputWrapper" tabindex="0">
        <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
        </div>
        <div class="jp-InputArea jp-Cell-inputArea">
            <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
                <h3 id="Interactive-Output-Projection-Visualization"
                    style="font-size: 28px; font-weight: 700; color: #212529; margin-bottom: 20px; margin-top: 30px;">
                    Understanding Output Projection (out_proj)</h3>

                <style>
                    .outproj-container {
                        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
                        padding: 20px;
                        border-radius: 0;
                        margin: 0;
                        width: 100%;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    }

                    .outproj-header {
                        text-align: center;
                        margin-bottom: 40px;
                    }

                    .outproj-header h2 {
                        font-size: 32px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 12px;
                    }

                    .outproj-header p {
                        font-size: 18px;
                        color: #6c757d;
                        max-width: 800px;
                        margin: 0 auto;
                    }

                    .step-navigation {
                        display: flex;
                        justify-content: center;
                        gap: 20px;
                        margin-bottom: 30px;
                        margin-top: 10px;
                        flex-wrap: wrap;
                    }

                    .step-btn {
                        padding: 15px 30px;
                        background: white;
                        border: 3px solid #dee2e6;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: 600;
                        color: #6c757d;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .step-btn:hover {
                        border-color: #adb5bd;
                        transform: translateY(-2px);
                    }

                    .step-btn.active {
                        background: #0d6efd;
                        color: white;
                        border-color: #0d6efd;
                    }

                    .step-number {
                        width: 30px;
                        height: 30px;
                        background: #e9ecef;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 14px;
                        font-weight: 700;
                    }

                    .step-btn.active .step-number {
                        background: white;
                        color: #0d6efd;
                    }

                    .step-content {
                        background: white;
                        border-radius: 12px;
                        padding: 40px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        display: none;
                    }

                    .step-content.active {
                        display: block;
                    }

                    .step-title {
                        font-size: 28px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 16px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .step-description {
                        font-size: 16px;
                        color: #495057;
                        line-height: 1.8;
                        margin-bottom: 30px;
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 8px;
                        border-left: 4px solid #0d6efd;
                    }

                    /* Step 1: Individual Heads */
                    .heads-display {
                        margin: 30px 0;
                    }

                    .head-item {
                        background: white;
                        border: 2px solid #dee2e6;
                        border-radius: 10px;
                        padding: 20px;
                        margin-bottom: 20px;
                        transition: all 0.3s ease;
                    }

                    .head-item:hover {
                        border-color: #0d6efd;
                        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
                    }

                    .head-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 15px;
                    }

                    .head-title {
                        font-size: 18px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .head-color-box {
                        width: 30px;
                        height: 30px;
                        border-radius: 6px;
                        border: 2px solid rgba(0, 0, 0, 0.1);
                    }

                    .head-dim-label {
                        font-size: 14px;
                        color: #6c757d;
                        background: #f8f9fa;
                        padding: 6px 12px;
                        border-radius: 6px;
                        font-weight: 600;
                    }

                    .head-output-viz {
                        display: flex;
                        gap: 2px;
                        height: 40px;
                        border-radius: 6px;
                        overflow: hidden;
                    }

                    .head-output-cell {
                        flex: 1;
                        transition: all 0.2s ease;
                        cursor: pointer;
                        position: relative;
                    }

                    .head-output-cell:hover {
                        transform: scaleY(1.3);
                        z-index: 10;
                    }

                    /* Step 2: Concatenation */
                    .concat-demonstration {
                        margin: 30px 0;
                    }

                    .concat-before {
                        margin-bottom: 30px;
                    }

                    .concat-arrow {
                        text-align: center;
                        font-size: 40px;
                        color: #0d6efd;
                        margin: 20px 0;
                        font-weight: 700;
                    }

                    .concat-after {
                        background: #f8f9fa;
                        padding: 30px;
                        border-radius: 10px;
                        border: 3px dashed #0d6efd;
                    }

                    .concat-result-label {
                        font-size: 16px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 15px;
                        text-align: center;
                    }

                    .concat-result-viz {
                        display: flex;
                        height: 60px;
                        border-radius: 8px;
                        overflow: hidden;
                        border: 3px solid #0d6efd;
                    }

                    .concat-segment {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                    }

                    .concat-segment:hover {
                        transform: scaleY(1.2);
                        z-index: 10;
                    }

                    .concat-segment::before {
                        content: attr(data-label);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    .concat-segment:hover::before {
                        opacity: 1;
                    }

                    /* Step 3: The Problem */
                    .problem-highlight {
                        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
                        border: 3px solid #ffc107;
                        border-radius: 10px;
                        padding: 30px;
                        margin: 30px 0;
                    }

                    .problem-title {
                        font-size: 22px;
                        font-weight: 700;
                        color: #856404;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .problem-description {
                        font-size: 16px;
                        color: #856404;
                        line-height: 1.8;
                        margin-bottom: 20px;
                    }

                    .isolated-heads-demo {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin: 20px 0;
                    }

                    .isolated-head {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        border: 2px solid #ffc107;
                        text-align: center;
                    }

                    .isolated-head-title {
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 10px;
                    }

                    .isolated-head-content {
                        font-size: 14px;
                        color: #6c757d;
                        font-style: italic;
                    }

                    /* Step 4: Weight Matrix - Enhanced */
                    .weight-matrix-section {
                        margin: 30px 0;
                    }

                    .wm-overview {
                        background: #e7f5ff;
                        border: 2px solid #0d6efd;
                        border-radius: 10px;
                        padding: 25px;
                        margin-bottom: 30px;
                    }

                    .wm-overview-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: #0d6efd;
                        margin-bottom: 15px;
                        text-align: center;
                    }

                    .wm-concept-grid {
                        display: grid;
                        grid-template-columns: 1fr 2fr;
                        gap: 25px;
                        align-items: center;
                        margin: 20px 0;
                    }

                    .wm-concept-text {
                        font-size: 15px;
                        line-height: 1.7;
                        color: #1971c2;
                    }

                    .wm-concept-text strong {
                        color: #1864ab;
                        background: #fff;
                        padding: 2px 6px;
                        border-radius: 3px;
                    }

                    .head-legend {
                        display: flex;
                        justify-content: center;
                        gap: 15px;
                        margin: 20px 0;
                        flex-wrap: wrap;
                    }

                    .legend-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 16px;
                        background: white;
                        border-radius: 8px;
                        border: 2px solid #dee2e6;
                    }

                    .legend-color {
                        width: 24px;
                        height: 24px;
                        border-radius: 4px;
                        border: 2px solid rgba(0, 0, 0, 0.1);
                    }

                    .legend-label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #212529;
                    }

                    .simple-matrix-demo {
                        background: #f8f9fa;
                        padding: 25px;
                        border-radius: 10px;
                        margin: 25px 0;
                    }

                    .simple-matrix-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 15px;
                        text-align: center;
                    }

                    .matrix-table {
                        width: 100%;
                        max-width: 800px;
                        margin: 20px auto;
                        border-collapse: separate;
                        border-spacing: 0;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    }

                    .matrix-table th,
                    .matrix-table td {
                        padding: 16px 12px;
                        text-align: center;
                        border: 2px solid #dee2e6;
                        background: white;
                        font-size: 13px;
                        line-height: 1.4;
                    }

                    .matrix-table th {
                        background: #0d6efd;
                        color: white;
                        font-weight: 700;
                        font-size: 11px;
                        padding: 12px 10px;
                        vertical-align: middle;
                    }

                    .matrix-table th.corner {
                        background: #212529;
                        font-size: 12px;
                        font-weight: 700;
                    }

                    .matrix-table th.row-header {
                        background: #20c997;
                        color: white;
                        font-weight: 700;
                        font-size: 12px;
                        padding: 12px 10px;
                        min-width: 80px;
                    }

                    .matrix-table td {
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                        font-weight: 600;
                    }

                    .matrix-table td:hover {
                        background: #fff3cd;
                        transform: scale(1.1);
                        z-index: 10;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    }

                    .matrix-table td.highlighted {
                        background: #d1ecf1;
                        border-color: #0d6efd;
                        font-weight: 700;
                    }

                    .matrix-cell-group {
                        cursor: pointer;
                    }

                    .cell-rect {
                        transition: all 0.2s ease;
                    }

                    .cell-explanation {
                        background: white;
                        border: 3px solid #0d6efd;
                        border-radius: 10px;
                        padding: 25px;
                        margin-top: 25px;
                        display: none;
                    }

                    .cell-explanation.show {
                        display: block;
                    }

                    .cell-exp-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #e9ecef;
                    }

                    .cell-exp-section {
                        margin-bottom: 20px;
                    }

                    .cell-exp-section-title {
                        font-size: 14px;
                        font-weight: 700;
                        color: #0d6efd;
                        text-transform: uppercase;
                        margin-bottom: 10px;
                        letter-spacing: 0.5px;
                    }

                    .cell-exp-content {
                        font-size: 15px;
                        color: #495057;
                        line-height: 1.7;
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #0d6efd;
                    }

                    .visual-demo-inline {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 15px;
                        margin: 20px 0;
                        flex-wrap: wrap;
                    }

                    .demo-box {
                        padding: 15px 20px;
                        border-radius: 8px;
                        text-align: center;
                        min-width: 120px;
                    }

                    .demo-box-input {
                        background: #e7f5ff;
                        border: 3px solid #0d6efd;
                    }

                    .demo-box-weight {
                        background: #fff3cd;
                        border: 3px solid #ffc107;
                    }

                    .demo-box-output {
                        background: #d1f4e0;
                        border: 3px solid #20c997;
                    }

                    .demo-box-label {
                        font-size: 11px;
                        font-weight: 600;
                        color: #6c757d;
                        margin-bottom: 6px;
                        text-transform: uppercase;
                    }

                    .demo-box-value {
                        font-size: 22px;
                        font-weight: 700;
                        color: #212529;
                    }

                    .demo-arrow-inline {
                        font-size: 28px;
                        color: #6c757d;
                        font-weight: 700;
                    }

                    .matrix-visual {
                        background: #f8f9fa;
                        padding: 30px;
                        border-radius: 10px;
                        margin: 20px 0;
                    }

                    .matrix-label {
                        font-size: 18px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 20px;
                        text-align: center;
                    }

                    .matrix-grid {
                        display: grid;
                        gap: 2px;
                        background: #dee2e6;
                        border-radius: 8px;
                        overflow: hidden;
                        max-width: 600px;
                        margin: 0 auto;
                    }

                    .matrix-cell {
                        aspect-ratio: 1;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                    }

                    .matrix-cell:hover {
                        transform: scale(1.3);
                        z-index: 100;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    }

                    .matrix-explanation {
                        background: #e7f5ff;
                        border: 2px solid #339af0;
                        border-radius: 10px;
                        padding: 25px;
                        margin-top: 30px;
                    }

                    .matrix-explanation-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #1864ab;
                        margin-bottom: 12px;
                    }

                    .matrix-explanation-text {
                        font-size: 15px;
                        color: #1971c2;
                        line-height: 1.7;
                    }

                    /* Step 5: Mixing Process */
                    .mixing-demo {
                        margin: 30px 0;
                    }

                    .mixing-equation {
                        background: white;
                        border: 3px solid #20c997;
                        border-radius: 10px;
                        padding: 30px;
                        margin: 20px 0;
                        text-align: center;
                    }

                    .equation-text {
                        font-size: 24px;
                        font-weight: 700;
                        color: #212529;
                        font-family: 'Courier New', monospace;
                        margin-bottom: 20px;
                    }

                    .equation-breakdown {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }

                    .equation-term {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        border-left: 4px solid #20c997;
                    }

                    .term-symbol {
                        font-size: 18px;
                        font-weight: 700;
                        color: #212529;
                        font-family: 'Courier New', monospace;
                        margin-bottom: 8px;
                    }

                    .term-description {
                        font-size: 14px;
                        color: #6c757d;
                    }

                    .mixing-visualization {
                        margin: 30px 0;
                    }

                    .mixing-step {
                        background: #f8f9fa;
                        padding: 25px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        border-left: 5px solid #20c997;
                    }

                    .mixing-step-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #212529;
                        margin-bottom: 12px;
                    }

                    .mixing-step-content {
                        font-size: 15px;
                        color: #495057;
                        line-height: 1.7;
                    }

                    .contribution-example {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        margin-top: 15px;
                        border: 2px solid #dee2e6;
                    }

                    .contrib-bar {
                        display: flex;
                        align-items: center;
                        margin-bottom: 10px;
                    }

                    .contrib-label {
                        width: 100px;
                        font-weight: 600;
                        font-size: 14px;
                        color: #212529;
                    }

                    .contrib-bar-bg {
                        flex: 1;
                        height: 30px;
                        background: #e9ecef;
                        border-radius: 6px;
                        overflow: hidden;
                        position: relative;
                    }

                    .contrib-bar-fill {
                        height: 100%;
                        border-radius: 6px;
                        display: flex;
                        align-items: center;
                        padding: 0 10px;
                        color: white;
                        font-weight: 700;
                        font-size: 13px;
                        transition: width 1s ease;
                    }

                    /* Step 6: Final Output */
                    .output-comparison {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 30px;
                        margin: 30px 0;
                    }

                    .comparison-panel {
                        background: white;
                        border: 3px solid #dee2e6;
                        border-radius: 10px;
                        padding: 25px;
                    }

                    .comparison-panel.before {
                        border-color: #ffc107;
                    }

                    .comparison-panel.after {
                        border-color: #20c997;
                    }

                    .comparison-title {
                        font-size: 20px;
                        font-weight: 700;
                        margin-bottom: 15px;
                        text-align: center;
                    }

                    .comparison-panel.before .comparison-title {
                        color: #ffc107;
                    }

                    .comparison-panel.after .comparison-title {
                        color: #20c997;
                    }

                    .comparison-viz {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .comparison-row {
                        display: flex;
                        gap: 2px;
                        height: 30px;
                        border-radius: 6px;
                        overflow: hidden;
                    }

                    .comparison-cell {
                        flex: 1;
                    }

                    .key-difference {
                        background: linear-gradient(135deg, #d0f4de 0%, #a7f3d0 100%);
                        border: 2px solid #20c997;
                        border-radius: 10px;
                        padding: 25px;
                        margin-top: 30px;
                    }

                    .key-difference-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: #0f766e;
                        margin-bottom: 15px;
                    }

                    .key-difference-text {
                        font-size: 16px;
                        color: #0f766e;
                        line-height: 1.8;
                    }

                    /* PyTorch Code Display */
                    .pytorch-code {
                        background: #1e1e1e;
                        color: #d4d4d4;
                        padding: 25px;
                        border-radius: 10px;
                        font-family: 'Courier New', monospace;
                        font-size: 14px;
                        line-height: 1.6;
                        margin: 20px 0;
                        overflow-x: auto;
                    }

                    .code-comment {
                        color: #6a9955;
                    }

                    .code-keyword {
                        color: #569cd6;
                    }

                    .code-string {
                        color: #ce9178;
                    }

                    .code-number {
                        color: #b5cea8;
                    }

                    .code-function {
                        color: #dcdcaa;
                    }

                    /* Tooltips */
                    .viz-tooltip {
                        position: absolute;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 6px;
                        font-size: 13px;
                        pointer-events: none;
                        z-index: 10000;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        white-space: pre-line;
                        max-width: 300px;
                    }

                    .viz-tooltip.show {
                        opacity: 1;
                    }

                    /* Responsive */
                    @media (max-width: 768px) {
                        .output-comparison {
                            grid-template-columns: 1fr;
                        }

                        .wm-concept-grid {
                            grid-template-columns: 1fr;
                        }

                        .step-navigation {
                            flex-wrap: wrap;
                        }

                        .step-btn {
                            font-size: 14px;
                            padding: 12px 20px;
                        }
                    }
                </style>

                <div class="outproj-container">
                    <!-- Step Navigation -->
                    <div class="step-navigation">
                        <button class="step-btn active" data-step="1">
                            <span class="step-number">1</span>
                            <span>Individual Heads</span>
                        </button>
                        <button class="step-btn" data-step="2">
                            <span class="step-number">2</span>
                            <span>Concatenation</span>
                        </button>
                        <button class="step-btn" data-step="3">
                            <span class="step-number">3</span>
                            <span>The Problem</span>
                        </button>
                        <button class="step-btn" data-step="4">
                            <span class="step-number">4</span>
                            <span>Weight Matrix</span>
                        </button>
                        <button class="step-btn" data-step="5">
                            <span class="step-number">5</span>
                            <span>Mixing Process</span>
                        </button>
                        <button class="step-btn" data-step="6">
                            <span class="step-number">6</span>
                            <span>Final Output</span>
                        </button>
                    </div>

                    <!-- Step 1: Individual Heads -->
                    <div class="step-content active" data-step="1">
                        <div class="step-title">
                            <span style="color: #0d6efd;">üìä</span>
                            Step 1: Individual Attention Heads
                        </div>
                        <div class="step-description">
                            After multi-head attention runs, each head produces its own output for every token.
                            Each head has learned to focus on different patterns in the data.
                            Here we show 4 heads, each producing a 32-dimensional output vector for each token.
                            <br><br>
                            <strong>Each head specializes in a different aspect:</strong> Head 1 focuses on syntax and
                            grammar,
                            Head 2 on word positions, Head 3 on semantic roles (who does what), and Head 4 on entity
                            recognition.
                        </div>

                        <div class="heads-display" id="headsDisplay"></div>

                        <div class="pytorch-code">
                            <pre style="margin: 0;"><span class="code-comment"># After attention, each head produces output</span>
<span class="code-comment"># For example, with 4 heads and head_dim=32:</span>

num_heads = <span class="code-number">4</span>
head_dim = <span class="code-number">32</span>

<span class="code-comment"># Each head output shape: (batch_size, num_tokens, head_dim)</span>
<span class="code-comment"># For our example: (1, 4, 32)</span>

head_1_output = <span class="code-comment"># Shape: (4, 32) - 32 features for 4 tokens</span>
head_2_output = <span class="code-comment"># Shape: (4, 32) - 32 features for 4 tokens</span>
head_3_output = <span class="code-comment"># Shape: (4, 32) - 32 features for 4 tokens</span>
head_4_output = <span class="code-comment"># Shape: (4, 32) - 32 features for 4 tokens</span></pre>
                        </div>
                    </div>

                    <!-- Step 2: Concatenation -->
                    <div class="step-content" data-step="2">
                        <div class="step-title">
                            <span style="color: #0d6efd;">üîó</span>
                            Step 2: Concatenating All Heads
                        </div>
                        <div class="step-description">
                            We take all head outputs and place them side-by-side (concatenate) to form one long vector.
                            With 4 heads √ó 32 dimensions = 128 total dimensions.
                            <strong>Important:</strong> At this stage, the heads are just placed next to each other -
                            they don't interact yet!
                        </div>

                        <div class="concat-demonstration">
                            <div class="concat-before">
                                <div style="font-size: 16px; font-weight: 600; color: #212529; margin-bottom: 15px;">
                                    Before Concatenation: 4 Separate Head Outputs
                                </div>
                                <div id="concatBefore"></div>
                            </div>

                            <div class="concat-arrow">‚Üì Concatenate ‚Üì</div>

                            <div class="concat-after">
                                <div class="concat-result-label">
                                    After Concatenation: One Long Vector (d_out = 128)
                                </div>
                                <div class="concat-result-viz" id="concatResult"></div>
                                <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #6c757d;">
                                    Dimensions: 0-31 (Head 1) | 32-63 (Head 2) | 64-95 (Head 3) | 96-127 (Head 4)
                                </div>
                            </div>
                        </div>

                        <div class="pytorch-code">
                            <pre style="margin: 0;"><span class="code-comment"># PyTorch concatenates along the last dimension</span>
context_vec = torch.cat([head_1, head_2, head_3, head_4], dim=-<span class="code-number">1</span>)

<span class="code-comment"># Shape: (batch_size, num_tokens, num_heads * head_dim)</span>
<span class="code-comment"># For our example: (1, 4, 128)</span>
<span class="code-comment"># where 128 = 4 heads √ó 32 dim/head</span>

<span class="code-comment"># The concatenated vector for one token looks like:</span>
<span class="code-comment"># [h1_d0, h1_d1, ..., h1_d31, h2_d0, h2_d1, ..., h2_d31, h3_d0, ..., h4_d31]</span></pre>
                        </div>
                    </div>

                    <!-- Step 3: The Problem -->
                    <div class="step-content" data-step="3">
                        <div class="step-title">
                            <span style="color: #ffc107;">‚ö†Ô∏è</span>
                            Step 3: The Problem with Just Concatenation
                        </div>
                        <div class="step-description">
                            Right now, each head's information is isolated in its own section of the vector.
                            The heads cannot communicate with each other. This is like having 4 experts who each
                            wrote a report but never talked to each other!
                        </div>

                        <div class="problem-highlight">
                            <div class="problem-title">
                                üö´ Why This Is A Problem
                            </div>
                            <div class="problem-description">
                                Imagine Head 1 (Syntax Detector) found "subject-verb agreement", Head 2 (Positional
                                Expert) detected "beginning of sentence",
                                Head 3 (Semantic Role Finder) identified "proper noun as subject", and Head 4 (Entity
                                Recognizer) detected "person's name".
                                <br><br>
                                <strong>Without mixing these insights, the model can't combine them to
                                    conclude:</strong>
                                "This is a person's name serving as the subject at the start of a sentence with proper
                                verb agreement,
                                so it should be capitalized and treated as the sentence's main actor."
                            </div>

                            <div class="isolated-heads-demo">
                                <div class="isolated-head" style="border-color: #e63946;">
                                    <div class="isolated-head-title" style="color: #e63946;">Head 1 (Isolated)</div>
                                    <div class="isolated-head-content">Syntax Detector: "Subject-verb match"</div>
                                </div>
                                <div class="isolated-head" style="border-color: #f77f00;">
                                    <div class="isolated-head-title" style="color: #f77f00;">Head 2 (Isolated)</div>
                                    <div class="isolated-head-content">Positional Expert: "Sentence start"</div>
                                </div>
                                <div class="isolated-head" style="border-color: #fcbf49;">
                                    <div class="isolated-head-title" style="color: #fcbf49;">Head 3 (Isolated)</div>
                                    <div class="isolated-head-content">Semantic Role: "Subject actor"</div>
                                </div>
                                <div class="isolated-head" style="border-color: #06a77d;">
                                    <div class="isolated-head-title" style="color: #06a77d;">Head 4 (Isolated)</div>
                                    <div class="isolated-head-content">Entity Recognizer: "Person name"</div>
                                </div>
                            </div>

                            <div
                                style="text-align: center; margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 700; color: #212529; margin-bottom: 10px;">
                                    We Need: Cross-Head Communication!
                                </div>
                                <div style="font-size: 15px; color: #6c757d;">
                                    The output projection layer (out_proj) solves this by learning how to mix
                                    information from all heads together.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Weight Matrix - ENHANCED VERSION -->
                    <div class="step-content" data-step="4">
                        <div class="step-title">
                            <span style="color: #0d6efd;">üî¢</span>
                            Step 4: The Weight Matrix (W_out)
                        </div>
                        <div class="step-description">
                            The output projection uses a weight matrix <code>W_out</code> with shape (128, 128).
                            Let's understand exactly what each row, column, and cell represents!
                        </div>

                        <!-- Conceptual Overview -->
                        <div class="wm-overview">
                            <div class="wm-overview-title">üéØ What is W_out?</div>

                            <div class="wm-concept-grid">
                                <div>
                                    <svg width="240" height="240" style="display: block; margin: 0 auto;">
                                        <!-- Title -->
                                        <text x="120" y="20" text-anchor="middle" font-size="16" font-weight="bold"
                                            fill="#212529">W_out Matrix</text>

                                        <!-- Main matrix border with better styling -->
                                        <rect x="35" y="40" width="150" height="150" fill="#f8f9fa" stroke="#0d6efd"
                                            stroke-width="4" rx="6" />

                                        <!-- Grid lines to show 4x4 structure clearly -->
                                        <!-- Horizontal lines -->
                                        <line x1="35" y1="77.5" x2="185" y2="77.5" stroke="#dee2e6" stroke-width="2" />
                                        <line x1="35" y1="115" x2="185" y2="115" stroke="#dee2e6" stroke-width="2" />
                                        <line x1="35" y1="152.5" x2="185" y2="152.5" stroke="#dee2e6"
                                            stroke-width="2" />

                                        <!-- Vertical lines -->
                                        <line x1="72.5" y1="40" x2="72.5" y2="190" stroke="#dee2e6" stroke-width="2" />
                                        <line x1="110" y1="40" x2="110" y2="190" stroke="#dee2e6" stroke-width="2" />
                                        <line x1="147.5" y1="40" x2="147.5" y2="190" stroke="#dee2e6"
                                            stroke-width="2" />

                                        <!-- Sample weight values in each cell -->
                                        <text x="53.75" y="63" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.3</text>
                                        <text x="91.25" y="63" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.7</text>
                                        <text x="128.75" y="63" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.1</text>
                                        <text x="166.25" y="63" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.5</text>

                                        <text x="53.75" y="100.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.9</text>
                                        <text x="91.25" y="100.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.2</text>
                                        <text x="128.75" y="100.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.6</text>
                                        <text x="166.25" y="100.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.4</text>

                                        <text x="53.75" y="138" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.4</text>
                                        <text x="91.25" y="138" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.8</text>
                                        <text x="128.75" y="138" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.3</text>
                                        <text x="166.25" y="138" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.9</text>

                                        <text x="53.75" y="175.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.2</text>
                                        <text x="91.25" y="175.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.5</text>
                                        <text x="128.75" y="175.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.7</text>
                                        <text x="166.25" y="175.5" text-anchor="middle" font-size="11" font-weight="600"
                                            fill="#495057">0.1</text>

                                        <!-- Column label on top -->
                                        <text x="110" y="33" text-anchor="middle" font-size="12" fill="#0d6efd"
                                            font-weight="bold">128 columns ‚Üí</text>

                                        <!-- Row label on left (rotated) -->
                                        <text x="18" y="115" font-size="12" fill="#20c997" font-weight="bold"
                                            text-anchor="middle" transform="rotate(-90 18 115)">128 rows ‚Üí</text>

                                        <!-- Dimension label at bottom -->
                                        <text x="120" y="210" text-anchor="middle" font-size="13" font-weight="600"
                                            fill="#6c757d">Shape: (128, 128)</text>

                                        <!-- Additional clarifying labels -->
                                        <text x="120" y="227" text-anchor="middle" font-size="10" fill="#868e96">Each
                                            cell = learned weight</text>
                                    </svg>
                                </div>

                                <div class="wm-concept-text">
                                    <p><strong>W_out is a learned weight matrix</strong> (128, 128).</p>
                                    <p style="margin-top: 12px;">Think of it as a recipe book:</p>
                                    <ul style="margin: 8px 0; padding-left: 18px; font-size: 14px;">
                                        <li><strong>Each ROW</strong> = Recipe for 1 output feature</li>
                                        <li><strong>Each COLUMN</strong> = 1 ingredient (input feature)</li>
                                        <li><strong>Each CELL</strong> = How much of that ingredient</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Head Legend -->
                        <div class="head-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #e63946;"></div>
                                <div class="legend-label">Head 1: Syntax Detector (dims 0-31)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f77f00;"></div>
                                <div class="legend-label">Head 2: Positional Expert (dims 32-63)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #fcbf49;"></div>
                                <div class="legend-label">Head 3: Semantic Role Finder (dims 64-95)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #06a77d;"></div>
                                <div class="legend-label">Head 4: Entity Recognizer (dims 96-127)</div>
                            </div>
                        </div>

                        <!-- Simplified Matrix -->
                        <div class="simple-matrix-demo">
                            <div class="simple-matrix-title">üìã Simplified 4√ó4 Matrix (Click any cell!)</div>
                            <p
                                style="text-align: center; color: #6c757d; margin-bottom: 20px; font-size: 14px; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                                Showing 1 dimension per head instead of 32 for clarity. This represents how the full
                                128√ó128 matrix works,
                                but simplified to 4√ó4 so you can see the structure clearly.
                            </p>

                            <!-- Matrix Structure Guide -->
                            <div
                                style="background: #e7f5ff; border: 2px solid #0d6efd; border-radius: 8px; padding: 20px; margin-bottom: 25px; max-width: 700px; margin-left: auto; margin-right: auto;">
                                <div style="font-size: 15px; font-weight: 700; color: #0d6efd; margin-bottom: 12px;">üìñ
                                    How to Read This Matrix:</div>
                                <div style="font-size: 14px; color: #1971c2; line-height: 1.7;">
                                    ‚Ä¢ <strong>Columns (top, blue/colored headers):</strong> Input dimensions from
                                    concatenated heads<br>
                                    ‚Ä¢ <strong>Rows (left, green headers):</strong> Output dimensions to be created<br>
                                    ‚Ä¢ <strong>Cell values:</strong> How much the input (column) contributes to the
                                    output (row)<br>
                                    ‚Ä¢ <strong>Example:</strong> Cell [0, 32] = 0.3 means "Input Dim 32 contributes 0.3
                                    to Output Dim 0"
                                </div>
                            </div>

                            <table class="matrix-table" id="simpleMatrix">
                                <thead>
                                    <tr>
                                        <th class="corner" style="width: 100px;">W_out<br>Matrix</th>
                                        <th style="background: #e63946; min-width: 120px;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">Input Dim 0</div>
                                            <div style="font-size: 10px; opacity: 0.95;">(Head 1: Syntax)</div>
                                        </th>
                                        <th style="background: #f77f00; min-width: 120px;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">Input Dim 32</div>
                                            <div style="font-size: 10px; opacity: 0.95;">(Head 2: Position)</div>
                                        </th>
                                        <th style="background: #fcbf49; min-width: 120px;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">Input Dim 64</div>
                                            <div style="font-size: 10px; opacity: 0.95;">(Head 3: Semantic)</div>
                                        </th>
                                        <th style="background: #06a77d; min-width: 120px;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">Input Dim 96</div>
                                            <div style="font-size: 10px; opacity: 0.95;">(Head 4: Entity)</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th class="row-header">
                                            <div style="font-weight: 700;">Output</div>
                                            <div style="font-weight: 700;">Dim 0</div>
                                        </th>
                                        <td data-row="0" data-col="0" data-value="0.8">0.8</td>
                                        <td data-row="0" data-col="32" data-value="0.3">0.3</td>
                                        <td data-row="0" data-col="64" data-value="0.1">0.1</td>
                                        <td data-row="0" data-col="96" data-value="0.2">0.2</td>
                                    </tr>
                                    <tr>
                                        <th class="row-header">
                                            <div style="font-weight: 700;">Output</div>
                                            <div style="font-weight: 700;">Dim 32</div>
                                        </th>
                                        <td data-row="32" data-col="0" data-value="0.2">0.2</td>
                                        <td data-row="32" data-col="32" data-value="0.9">0.9</td>
                                        <td data-row="32" data-col="64" data-value="0.4">0.4</td>
                                        <td data-row="32" data-col="96" data-value="0.1">0.1</td>
                                    </tr>
                                    <tr>
                                        <th class="row-header">
                                            <div style="font-weight: 700;">Output</div>
                                            <div style="font-weight: 700;">Dim 64</div>
                                        </th>
                                        <td data-row="64" data-col="0" data-value="0.1">0.1</td>
                                        <td data-row="64" data-col="32" data-value="0.5">0.5</td>
                                        <td data-row="64" data-col="64" data-value="0.7">0.7</td>
                                        <td data-row="64" data-col="96" data-value="0.3">0.3</td>
                                    </tr>
                                    <tr>
                                        <th class="row-header">
                                            <div style="font-weight: 700;">Output</div>
                                            <div style="font-weight: 700;">Dim 96</div>
                                        </th>
                                        <td data-row="96" data-col="0" data-value="0.3">0.3</td>
                                        <td data-row="96" data-col="32" data-value="0.2">0.2</td>
                                        <td data-row="96" data-col="64" data-value="0.4">0.4</td>
                                        <td data-row="96" data-col="96" data-value="0.8">0.8</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Visual Guide Below Matrix -->
                            <div
                                style="max-width: 800px; margin: 25px auto 0; display: flex; justify-content: space-between; align-items: center;">
                                <div
                                    style="flex: 1; text-align: left; padding: 15px; background: #d1f4e0; border-radius: 8px; border-left: 4px solid #20c997;">
                                    <div style="font-size: 12px; font-weight: 700; color: #0f766e; margin-bottom: 4px;">
                                        ‚Üê ROWS (Green)</div>
                                    <div style="font-size: 11px; color: #0f766e;">Each row creates one output feature
                                    </div>
                                </div>
                                <div style="width: 40px; text-align: center; font-size: 24px; color: #6c757d;">‚ü∑</div>
                                <div
                                    style="flex: 1; text-align: right; padding: 15px; background: #dbeafe; border-radius: 8px; border-right: 4px solid #0d6efd;">
                                    <div style="font-size: 12px; font-weight: 700; color: #1e40af; margin-bottom: 4px;">
                                        COLUMNS (Blue) ‚Üí</div>
                                    <div style="font-size: 11px; color: #1e40af;">Each column is one input feature</div>
                                </div>
                            </div>

                            <!-- Cell Explanation Box -->
                            <div class="cell-explanation" id="cellExplanation">
                                <div class="cell-exp-title" id="cellExpTitle"></div>

                                <div class="cell-exp-section">
                                    <div class="cell-exp-section-title">üìç Location in Matrix</div>
                                    <div class="cell-exp-content" id="cellExpLocation"></div>
                                </div>

                                <div class="cell-exp-section">
                                    <div class="cell-exp-section-title">üí° What This Cell Means</div>
                                    <div class="cell-exp-content" id="cellExpMeaning"></div>
                                </div>

                                <div class="cell-exp-section">
                                    <div class="cell-exp-section-title">üìä Value Interpretation</div>
                                    <div class="cell-exp-content" id="cellExpValue"></div>
                                </div>

                                <div class="cell-exp-section">
                                    <div class="cell-exp-section-title">üßÆ In the Computation</div>
                                    <div class="cell-exp-content" id="cellExpComputation"></div>
                                </div>

                                <div class="visual-demo-inline" id="visualDemo"></div>
                            </div>
                        </div>

                        <div class="matrix-explanation">
                            <div class="matrix-explanation-title">üìö Key Concepts:</div>
                            <div class="matrix-explanation-text">
                                ‚Ä¢ <strong>Each ROW</strong> creates one output feature using ALL 128 input features<br>
                                ‚Ä¢ <strong>Each COLUMN</strong> shows how one input feature contributes to ALL 128
                                outputs<br>
                                ‚Ä¢ <strong>Each CELL [i,j]</strong> controls: "How much does input j contribute to output
                                i?"<br>
                                ‚Ä¢ <strong>During training</strong>, these weights learn optimal mixing patterns!<br><br>

                                <strong>Example:</strong> Row 64 might learn to combine Head 1's "syntax patterns" +
                                Head 2's "position info"
                                + Head 3's "semantic roles" + Head 4's "entity types" to create an output feature that
                                detects
                                "proper nouns serving as sentence subjects" ‚Äî a combination no single head could detect
                                alone!
                            </div>
                        </div>

                        <div class="pytorch-code">
                            <pre style="margin: 0;"><span class="code-comment"># The output projection is a linear layer</span>
<span class="code-keyword">self</span>.out_proj = nn.Linear(d_out, d_out)

<span class="code-comment"># Where d_out = num_heads √ó head_dim = 4 √ó 32 = 128</span>
<span class="code-comment"># This creates:</span>
<span class="code-comment">#   - Weight matrix W_out with shape (128, 128)</span>
<span class="code-comment">#   - Bias vector b_out with shape (128,)</span>

<span class="code-comment"># Accessing specific elements:</span>
<span class="code-comment"># W_out[64, 32] = weight connecting input dim 32 ‚Üí output dim 64</span>

<span class="code-comment"># Row 64 (all 128 values) = recipe for output feature 64</span>
<span class="code-comment"># Column 32 (all 128 values) = how input 32 affects all outputs</span></pre>
                        </div>
                    </div>

                    <!-- Step 5: Mixing Process -->
                    <div class="step-content" data-step="5">
                        <div class="step-title">
                            <span style="color: #20c997;">‚ö°</span>
                            Step 5: The Mixing Process
                        </div>
                        <div class="step-description">
                            Now we apply the transformation:
                            <code>output = context_vec @ W_out<sup>T</sup> + b_out</code>.
                            This multiplies our concatenated vector (128 dimensions) by the weight matrix, creating a
                            new 128-dimensional vector where each feature is a learned mixture of all head outputs.
                        </div>

                        <div class="mixing-demo">
                            <div class="mixing-equation">
                                <div class="equation-text">output = context_vec @ W_out<sup>T</sup> + b_out</div>
                                <div class="equation-breakdown">
                                    <div class="equation-term">
                                        <div class="term-symbol">context_vec</div>
                                        <div class="term-description">
                                            Shape: (4, 128)<br>
                                            Concatenated heads<br>
                                            4 tokens √ó 128 dims
                                        </div>
                                    </div>
                                    <div class="equation-term">
                                        <div class="term-symbol">W_out<sup>T</sup></div>
                                        <div class="term-description">
                                            Shape: (128, 128)<br>
                                            Learned weights<br>
                                            Mix all features
                                        </div>
                                    </div>
                                    <div class="equation-term">
                                        <div class="term-symbol">b_out</div>
                                        <div class="term-description">
                                            Shape: (128,)<br>
                                            Bias term<br>
                                            Shifts output
                                        </div>
                                    </div>
                                    <div class="equation-term">
                                        <div class="term-symbol">output</div>
                                        <div class="term-description">
                                            Shape: (4, 128)<br>
                                            Mixed features<br>
                                            4 tokens √ó 128 dims
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mixing-visualization">
                                <div class="mixing-step">
                                    <div class="mixing-step-title">Example: Creating Output Feature 64</div>
                                    <div class="mixing-step-content">
                                        Let's see how one output feature (dimension 64) is computed by mixing all head
                                        outputs.
                                        Each head contributes different amounts based on the learned weights in row 64
                                        of W_out:
                                    </div>
                                    <div class="contribution-example" id="contributionExample"></div>
                                </div>

                                <div class="mixing-step">
                                    <div class="mixing-step-title">The Magic: Cross-Head Learning</div>
                                    <div class="mixing-step-content">
                                        The weight matrix learns patterns like:<br><br>
                                        ‚Ä¢ "When Head 1 (Syntax) detects verb agreement AND Head 2 (Position) detects
                                        sentence-start ‚Üí strongly activate output feature 64"<br>
                                        ‚Ä¢ "Combine 60% of Head 3's (Semantic Role) actor detection with 30% of Head 4's
                                        (Entity) name recognition for feature 12"<br>
                                        ‚Ä¢ "If Head 4 (Entity) has low activation, suppress certain features from Head 3
                                        (Semantic Role)"<br>
                                        ‚Ä¢ "Mix Head 1's syntax patterns with Head 2's positional context to detect
                                        syntactic boundaries"<br><br>

                                        <strong>These patterns are not hand-coded - they are learned from data during
                                            training!</strong><br><br>

                                        For instance, the model might learn that combining:<br>
                                        ‚Ä¢ Head 1's syntax detection (subject identification)<br>
                                        ‚Ä¢ Head 2's positional awareness (start of sentence)<br>
                                        ‚Ä¢ Head 3's semantic role finding (actor/agent)<br>
                                        ‚Ä¢ Head 4's entity recognition (proper noun)<br>
                                        ‚Üí Creates a powerful feature for identifying "sentence-initial named subjects"
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pytorch-code">
                            <pre style="margin: 0;"><span class="code-comment"># Apply the output projection</span>
context_vec = <span class="code-keyword">self</span>.out_proj(context_vec)

<span class="code-comment"># Under the hood, this does:</span>
<span class="code-comment"># output = context_vec @ W_out^T + b_out</span>

<span class="code-comment"># For one token's vector (128 dims):</span>
<span class="code-comment"># output[i] = sum(context_vec[j] * W_out[i,j] for all j) + b_out[i]</span>

<span class="code-comment"># Example calculation for output dimension 64:</span>
output[<span class="code-number">64</span>] = (
    context_vec[<span class="code-number">0</span>] * W_out[<span class="code-number">64</span>,<span class="code-number">0</span>] +     <span class="code-comment"># Head 1, dim 0</span>
    context_vec[<span class="code-number">1</span>] * W_out[<span class="code-number">64</span>,<span class="code-number">1</span>] +     <span class="code-comment"># Head 1, dim 1</span>
    <span class="code-comment"># ... (all 128 input dimensions) ...</span>
    context_vec[<span class="code-number">127</span>] * W_out[<span class="code-number">64</span>,<span class="code-number">127</span>]   <span class="code-comment"># Head 4, dim 31</span>
) + b_out[<span class="code-number">64</span>]</pre>
                        </div>
                    </div>

                    <!-- Step 6: Final Output -->
                    <div class="step-content" data-step="6">
                        <div class="step-title">
                            <span style="color: #20c997;">‚úÖ</span>
                            Step 6: The Final Mixed Output
                        </div>
                        <div class="step-description">
                            After the output projection, we still have 128 dimensions (same as before),
                            but now each dimension contains mixed information from ALL heads.
                            The heads are no longer isolated - their insights have been integrated!
                        </div>

                        <div class="output-comparison">
                            <div class="comparison-panel before">
                                <div class="comparison-title">‚ùå Before out_proj<br>(Concatenated)</div>
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 15px; text-align: center;">
                                    Heads are isolated in segments
                                </div>
                                <div class="comparison-viz" id="beforeOutput"></div>
                            </div>

                            <div class="comparison-panel after">
                                <div class="comparison-title">‚úÖ After out_proj<br>(Mixed)</div>
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 15px; text-align: center;">
                                    All dimensions mix all heads
                                </div>
                                <div class="comparison-viz" id="afterOutput"></div>
                            </div>
                        </div>

                        <div class="key-difference">
                            <div class="key-difference-title">üéØ Key Difference</div>
                            <div class="key-difference-text">
                                <strong>Before out_proj:</strong> Dimensions 0-31 only have Head 1 info, 32-63 only have
                                Head 2 info, etc.<br><br>

                                <strong>After out_proj:</strong> EVERY dimension (0-127) now contains a learned mixture
                                of information from ALL 4 heads.
                                For example:<br>
                                ‚Ä¢ Dimension 5 might be 40% Head 1 + 30% Head 2 + 20% Head 3 + 10% Head 4<br>
                                ‚Ä¢ Dimension 64 might be 10% Head 1 + 60% Head 2 + 25% Head 3 + 5% Head 4<br>
                                ‚Ä¢ Each dimension learns its own unique mixing pattern!<br><br>

                                This integrated representation is then passed to the next layer of the transformer
                                (typically a feed-forward network), carrying rich, multi-perspective information about
                                each token.
                            </div>
                        </div>

                        <div class="pytorch-code">
                            <pre style="margin: 0;"><span class="code-comment"># Complete forward pass with output projection:</span>

<span class="code-keyword">class</span> <span class="code-function">MultiHeadAttention</span>(nn.Module):
    <span class="code-keyword">def</span> <span class="code-function">__init__</span>(<span class="code-keyword">self</span>, d_in, d_out, num_heads):
        <span class="code-keyword">super</span>().__init__()
        <span class="code-keyword">self</span>.num_heads = num_heads
        <span class="code-keyword">self</span>.head_dim = d_out // num_heads
        
        <span class="code-comment"># Q, K, V projections for all heads</span>
        <span class="code-keyword">self</span>.W_query = nn.Linear(d_in, d_out)
        <span class="code-keyword">self</span>.W_key = nn.Linear(d_in, d_out)
        <span class="code-keyword">self</span>.W_value = nn.Linear(d_in, d_out)
        
        <span class="code-comment"># Output projection - THIS IS THE KEY!</span>
        <span class="code-keyword">self</span>.out_proj = nn.Linear(d_out, d_out)
    
    <span class="code-keyword">def</span> <span class="code-function">forward</span>(<span class="code-keyword">self</span>, x):
        <span class="code-comment"># 1. Multi-head attention (produces concatenated heads)</span>
        <span class="code-comment"># ... attention computation ...</span>
        context_vec = <span class="code-comment"># Shape: (batch, tokens, d_out)</span>
        
        <span class="code-comment"># 2. Output projection - mix all heads together</span>
        context_vec = <span class="code-keyword">self</span>.out_proj(context_vec)
        
        <span class="code-comment"># Now context_vec has integrated multi-head information!</span>
        <span class="code-keyword">return</span> context_vec</pre>
                        </div>
                    </div>
                </div>

                <!-- Tooltip -->
                <div class="viz-tooltip" id="vizTooltip"></div>

                <script>
                    (function () {
                        // Configuration
                        const NUM_HEADS = 4;
                        const HEAD_DIM = 32;
                        const NUM_TOKENS = 4;
                        const D_OUT = NUM_HEADS * HEAD_DIM; // 128

                        // Better color scheme
                        const HEAD_COLORS = [
                            '#e63946', // Red
                            '#f77f00', // Orange  
                            '#fcbf49', // Yellow
                            '#06a77d'  // Teal
                        ];

                        const HEAD_NAMES = ['Head 1', 'Head 2', 'Head 3', 'Head 4'];

                        // Head specializations (what each head learns to detect)
                        const HEAD_ROLES = [
                            {
                                name: 'Syntax Detector',
                                description: 'Tracks grammatical relationships like subject-verb agreement',
                                example: 'Detects "cat sits" vs "cats sit"'
                            },
                            {
                                name: 'Positional Expert',
                                description: 'Focuses on word position and nearby context',
                                example: 'Identifies sentence beginnings and endings'
                            },
                            {
                                name: 'Semantic Role Finder',
                                description: 'Identifies who is doing what to whom',
                                example: 'Finds actors, actions, and objects'
                            },
                            {
                                name: 'Entity Recognizer',
                                description: 'Detects named entities and proper nouns',
                                example: 'Identifies names, places, organizations'
                            }
                        ];

                        // Generate synthetic data
                        function generateHeadOutput() {
                            const output = [];
                            for (let t = 0; t < NUM_TOKENS; t++) {
                                const token = [];
                                for (let d = 0; d < HEAD_DIM; d++) {
                                    token.push(Math.random());
                                }
                                output.push(token);
                            }
                            return output;
                        }

                        const headOutputs = Array(NUM_HEADS).fill(null).map(() => generateHeadOutput());

                        // Generate weight matrix
                        function generateWeightMatrix() {
                            const matrix = [];
                            for (let i = 0; i < D_OUT; i++) {
                                const row = [];
                                for (let j = 0; j < D_OUT; j++) {
                                    row.push(Math.random() * 0.8 + 0.1);
                                }
                                matrix.push(row);
                            }
                            return matrix;
                        }

                        const weightMatrix = generateWeightMatrix();

                        // Tooltip functions
                        function showTooltip(e, text) {
                            const tooltip = document.getElementById('vizTooltip');
                            tooltip.innerHTML = text;
                            tooltip.style.left = (e.pageX + 10) + 'px';
                            tooltip.style.top = (e.pageY + 10) + 'px';
                            tooltip.classList.add('show');
                        }

                        function hideTooltip() {
                            document.getElementById('vizTooltip').classList.remove('show');
                        }

                        // Step 1: Render individual heads
                        function renderStep1() {
                            const container = document.getElementById('headsDisplay');
                            container.innerHTML = '';

                            headOutputs.forEach((headOutput, headIdx) => {
                                const headItem = document.createElement('div');
                                headItem.className = 'head-item';

                                const header = document.createElement('div');
                                header.className = 'head-header';
                                header.innerHTML = `
                      <div class="head-title">
                        <div class="head-color-box" style="background: ${HEAD_COLORS[headIdx]};"></div>
                        <div>
                          <div style="font-size: 18px; font-weight: 700;">Head ${headIdx + 1}: ${HEAD_ROLES[headIdx].name}</div>
                          <div style="font-size: 13px; color: #6c757d; font-weight: 400; margin-top: 4px;">${HEAD_ROLES[headIdx].description}</div>
                        </div>
                      </div>
                      <div class="head-dim-label">${HEAD_DIM} dimensions</div>
                    `;

                                const viz = document.createElement('div');
                                viz.className = 'head-output-viz';

                                // Show one token's output (token 0)
                                headOutput[0].forEach((value, dimIdx) => {
                                    const cell = document.createElement('div');
                                    cell.className = 'head-output-cell';
                                    const intensity = Math.floor(value * 180) + 75;
                                    cell.style.background = `rgb(${intensity}, ${intensity}, ${intensity})`;
                                    cell.addEventListener('mouseenter', (e) => {
                                        showTooltip(e, `Head ${headIdx + 1} (${HEAD_ROLES[headIdx].name})\nDim ${dimIdx}: ${value.toFixed(3)}\n\n${HEAD_ROLES[headIdx].example}`);
                                    });
                                    cell.addEventListener('mouseleave', hideTooltip);
                                    viz.appendChild(cell);
                                });

                                headItem.appendChild(header);
                                headItem.appendChild(viz);
                                container.appendChild(headItem);
                            });
                        }

                        // Step 2: Render concatenation
                        function renderStep2() {
                            // Before concat
                            const beforeContainer = document.getElementById('concatBefore');
                            beforeContainer.innerHTML = '';

                            headOutputs.forEach((headOutput, headIdx) => {
                                const headBar = document.createElement('div');
                                headBar.style.cssText = `
                      height: 50px;
                      background: ${HEAD_COLORS[headIdx]};
                      margin-bottom: 10px;
                      border-radius: 6px;
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      padding: 0 15px;
                      color: white;
                      font-weight: 700;
                      cursor: pointer;
                    `;
                                headBar.innerHTML = `
                      <div>
                        <div style="font-size: 16px;">Head ${headIdx + 1}: ${HEAD_ROLES[headIdx].name}</div>
                        <div style="font-size: 11px; opacity: 0.9; font-weight: 400;">${HEAD_ROLES[headIdx].description}</div>
                      </div>
                      <div style="font-size: 14px; opacity: 0.9;">${HEAD_DIM} dims</div>
                    `;
                                headBar.addEventListener('mouseenter', (e) => {
                                    showTooltip(e, `Head ${headIdx + 1}: ${HEAD_ROLES[headIdx].name}\nDimensions ${headIdx * HEAD_DIM}-${(headIdx + 1) * HEAD_DIM - 1}\n\n${HEAD_ROLES[headIdx].example}`);
                                });
                                headBar.addEventListener('mouseleave', hideTooltip);
                                beforeContainer.appendChild(headBar);
                            });

                            // After concat
                            const resultContainer = document.getElementById('concatResult');
                            resultContainer.innerHTML = '';

                            HEAD_COLORS.forEach((color, headIdx) => {
                                const segment = document.createElement('div');
                                segment.className = 'concat-segment';
                                segment.style.background = color;
                                segment.setAttribute('data-label', `H${headIdx + 1}`);
                                segment.addEventListener('mouseenter', (e) => {
                                    showTooltip(e, `Head ${headIdx + 1}: ${HEAD_ROLES[headIdx].name}\nDimensions ${headIdx * HEAD_DIM}-${(headIdx + 1) * HEAD_DIM - 1}`);
                                });
                                segment.addEventListener('mouseleave', hideTooltip);
                                resultContainer.appendChild(segment);
                            });
                        }

                        // Step 4: Handle matrix cell clicks
                        const matrixCells = document.querySelectorAll('#simpleMatrix td');
                        const cellExplanation = document.getElementById('cellExplanation');

                        matrixCells.forEach(cell => {
                            cell.addEventListener('click', function () {
                                // Clear previous highlights
                                matrixCells.forEach(c => c.classList.remove('highlighted'));
                                this.classList.add('highlighted');

                                const row = parseInt(this.dataset.row);
                                const col = parseInt(this.dataset.col);
                                const value = parseFloat(this.dataset.value);

                                // Determine which head
                                let inputHead = Math.floor(col / HEAD_DIM);
                                let outputHead = Math.floor(row / HEAD_DIM);

                                // Update title
                                document.getElementById('cellExpTitle').textContent = `Cell W_out[${row}, ${col}] = ${value}`;

                                // Location
                                document.getElementById('cellExpLocation').innerHTML = `
                      ‚Ä¢ <strong>Row ${row}</strong>: This row creates output feature ${row}<br>
                      ‚Ä¢ <strong>Column ${col}</strong>: This column represents input dimension ${col} from ${HEAD_ROLES[inputHead].name}
                    `;

                                // Meaning
                                document.getElementById('cellExpMeaning').innerHTML = `
                      This cell controls <strong>how much input dimension ${col} (from ${HEAD_ROLES[inputHead].name}) 
                      contributes to output feature ${row}</strong>.<br><br>
                      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <strong>${HEAD_ROLES[inputHead].name}:</strong> ${HEAD_ROLES[inputHead].description}<br>
                        <em style="font-size: 13px; color: #6c757d;">${HEAD_ROLES[inputHead].example}</em>
                      </div><br>
                      When computing output[${row}], this weight determines how strongly 
                      the "${HEAD_ROLES[inputHead].name}" information from input[${col}] influences the result.
                    `;

                                // Value interpretation
                                const strength = value > 0.6 ? 'strong' : (value > 0.3 ? 'moderate' : 'weak');
                                const strengthColor = value > 0.6 ? '#20c997' : (value > 0.3 ? '#ffc107' : '#dc3545');

                                document.getElementById('cellExpValue').innerHTML = `
                      <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${strengthColor};">
                        <strong style="color: ${strengthColor};">Weight value = ${value} ‚Üí ${strength.toUpperCase()} connection</strong><br><br>
                        ${value > 0.6 ?
                                        `When input dimension ${col} has a large value, it will <strong>strongly increase</strong> output feature ${row}.` :
                                        value > 0.3 ?
                                            `Input dimension ${col} has <strong>moderate influence</strong> on output feature ${row}.` :
                                            `Input dimension ${col} has <strong>minimal influence</strong> on output feature ${row}.`
                                    }
                      </div>
                    `;

                                // Computation
                                document.getElementById('cellExpComputation').innerHTML = `
                      <div style="font-family: 'Courier New', monospace; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px;">
                        output[${row}] += input[${col}] √ó ${value}
                      </div>
                      <div style="margin-top: 10px; font-size: 13px; color: #6c757d;">
                        This is just ONE term in the sum of 128 terms that creates output feature ${row}. 
                        The complete calculation uses all 128 input dimensions.
                      </div>
                    `;

                                // Visual demo
                                const visualDemo = document.getElementById('visualDemo');
                                visualDemo.innerHTML = `
                      <div class="demo-box demo-box-input">
                        <div class="demo-box-label">Input ${col}</div>
                        <div class="demo-box-value">0.5</div>
                      </div>
                      <div class="demo-arrow-inline">√ó</div>
                      <div class="demo-box demo-box-weight">
                        <div class="demo-box-label">W[${row},${col}]</div>
                        <div class="demo-box-value">${value}</div>
                      </div>
                      <div class="demo-arrow-inline">=</div>
                      <div class="demo-box demo-box-output">
                        <div class="demo-box-label">Contribution</div>
                        <div class="demo-box-value">${(0.5 * value).toFixed(2)}</div>
                      </div>
                    `;

                                cellExplanation.classList.add('show');
                                cellExplanation.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            });

                            cell.addEventListener('mouseenter', function (e) {
                                const row = parseInt(this.dataset.row);
                                const col = parseInt(this.dataset.col);
                                const value = parseFloat(this.dataset.value);

                                let inputHead = Math.floor(col / HEAD_DIM);

                                showTooltip(e, `W_out[${row}, ${col}] = ${value}\n\nInput: Dim ${col} (${HEAD_ROLES[inputHead].name})\nOutput: Feature ${row}\n\nClick for detailed explanation`);
                            });

                            cell.addEventListener('mouseleave', hideTooltip);
                        });

                        // Step 5: Render contribution example
                        function renderStep5() {
                            const container = document.getElementById('contributionExample');
                            container.innerHTML = '';

                            // Calculate contribution from each head to output feature 64
                            const outputFeature = 64;
                            const contributions = [];

                            for (let h = 0; h < NUM_HEADS; h++) {
                                let sum = 0;
                                for (let d = 0; d < HEAD_DIM; d++) {
                                    const inputIdx = h * HEAD_DIM + d;
                                    sum += Math.abs(weightMatrix[outputFeature][inputIdx]);
                                }
                                contributions.push(sum);
                            }

                            const total = contributions.reduce((a, b) => a + b, 0);

                            contributions.forEach((contrib, headIdx) => {
                                const percentage = (contrib / total * 100).toFixed(1);

                                const bar = document.createElement('div');
                                bar.className = 'contrib-bar';
                                bar.innerHTML = `
                      <div class="contrib-label">Head ${headIdx + 1}:</div>
                      <div class="contrib-bar-bg">
                        <div class="contrib-bar-fill" style="width: ${percentage}%; background: ${HEAD_COLORS[headIdx]};">
                          ${percentage}%
                        </div>
                      </div>
                    `;
                                container.appendChild(bar);
                            });
                        }

                        // Step 6: Render before/after comparison
                        function renderStep6() {
                            // Before - show segmented by head
                            const beforeContainer = document.getElementById('beforeOutput');
                            beforeContainer.innerHTML = '';

                            for (let t = 0; t < NUM_TOKENS; t++) {
                                const row = document.createElement('div');
                                row.className = 'comparison-row';

                                HEAD_COLORS.forEach((color, headIdx) => {
                                    const segment = document.createElement('div');
                                    segment.className = 'comparison-cell';
                                    segment.style.background = color;
                                    segment.style.opacity = 0.3 + (headOutputs[headIdx][t][0] * 0.7);
                                    row.appendChild(segment);
                                });

                                beforeContainer.appendChild(row);
                            }

                            // After - show mixed
                            const afterContainer = document.getElementById('afterOutput');
                            afterContainer.innerHTML = '';

                            for (let t = 0; t < NUM_TOKENS; t++) {
                                const row = document.createElement('div');
                                row.className = 'comparison-row';

                                // Create mixed output
                                for (let section = 0; section < 4; section++) {
                                    const cell = document.createElement('div');
                                    cell.className = 'comparison-cell';

                                    // Mix all heads
                                    const mixedValue = headOutputs.reduce((sum, headOut, h) => {
                                        return sum + headOut[t][section * 8] * 0.25;
                                    }, 0);

                                    const intensity = Math.floor(mixedValue * 200) + 55;
                                    cell.style.background = `rgb(${Math.floor(intensity * 0.3)}, ${intensity - 20}, ${intensity})`;
                                    row.appendChild(cell);
                                }

                                afterContainer.appendChild(row);
                            }
                        }

                        // Initialize all steps
                        function initializeSteps() {
                            renderStep1();
                            renderStep2();
                            renderStep5();
                            renderStep6();
                        }

                        // Step navigation
                        const stepBtns = document.querySelectorAll('.step-btn');
                        const stepContents = document.querySelectorAll('.step-content');

                        stepBtns.forEach(btn => {
                            btn.addEventListener('click', () => {
                                const step = btn.getAttribute('data-step');

                                // Update buttons
                                stepBtns.forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');

                                // Update content
                                stepContents.forEach(content => {
                                    content.classList.remove('active');
                                    if (content.getAttribute('data-step') === step) {
                                        content.classList.add('active');
                                    }
                                });
                            });
                        });

                        // Initialize
                        initializeSteps();
                    })();
                </script>
            </div>
        </div>
    </div>
</div>