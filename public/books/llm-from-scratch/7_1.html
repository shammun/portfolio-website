<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Formatting: Alpaca vs. Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        pre, code, .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar for Code Block */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e1e1e; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes pulse-green {
            0%, 100% { background-color: #22c55e; }
            50% { background-color: #86efac; }
        }
        .animate-pulse-custom { animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-[#fafbff] to-[#f5f7ff] text-gray-800 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-6xl mx-auto flex flex-col h-[90vh] md:h-auto shadow-2xl rounded-2xl bg-white overflow-hidden relative">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-100 p-4 md:p-6 flex flex-col md:flex-row justify-between items-center z-10 sticky top-0">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
                    Prompt Formatting
                </h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">Alpaca vs. Chat Style</p>
            </div>
            
            <div id="step-pills" class="flex flex-wrap justify-center gap-2">
                <!-- Generated by JS -->
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col md:flex-row relative">
            
            <!-- Left: Visualization (60%) -->
            <div class="flex-1 p-6 md:p-10 flex flex-col bg-[#fafbff] relative overflow-y-auto">
                <div id="visual-container" class="flex-1 flex flex-col justify-center w-full max-w-2xl mx-auto min-h-[400px]">
                    <!-- Dynamic Content -->
                </div>

                <!-- Controls -->
                <div class="mt-8 flex items-center justify-between border-t border-gray-200 pt-6">
                    <button id="btn-prev" class="flex items-center text-sm font-semibold text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Previous
                    </button>

                    <button id="btn-play" class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg transition-all hover:scale-110 bg-indigo-600 text-white">
                        <!-- Icon swapped by JS -->
                        <svg id="icon-play" class="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg id="icon-pause" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>

                    <button id="btn-next" class="flex items-center text-sm font-semibold text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        Next
                        <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Right: Sidebar (40%) -->
            <div class="w-full md:w-[400px] bg-white border-l border-gray-100 flex flex-col shadow-[-10px_0_20px_rgba(0,0,0,0.02)] z-10 h-[40vh] md:h-auto">
                <div class="p-6 md:p-8 flex-1 overflow-y-auto custom-scrollbar">
                    <div class="flex items-center justify-between mb-6">
                        <span id="step-counter" class="text-xs font-bold uppercase tracking-wider text-indigo-500">
                            Step 1 of 8
                        </span>
                        <span id="play-indicator" class="h-2 w-2 rounded-full bg-gray-300"></span>
                    </div>

                    <h2 id="sidebar-title" class="text-2xl font-bold text-gray-900 mb-4 transition-all"></h2>
                    
                    <div id="sidebar-content" class="text-gray-600 leading-relaxed text-sm transition-all duration-300">
                        <!-- Explanation Content -->
                    </div>

                    <div id="view-code-wrapper" class="mt-8 hidden">
                        <button id="btn-view-code" class="w-full group relative flex items-center justify-center p-4 bg-[#1e1e1e] rounded-xl text-white shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1 overflow-hidden">
                             <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                             <svg class="w-5 h-5 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                             <span class="font-mono text-sm">View Implementation</span>
                        </button>
                        <p class="text-center text-xs text-gray-400 mt-2">Python code logic for this step</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Code Modal -->
        <div id="code-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
            <div class="bg-[#1e1e1e] w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative transform scale-95 transition-transform duration-300" id="code-modal-content">
                
                <!-- Modal Header -->
                <div class="flex items-center justify-between px-6 py-4 bg-[#252526] border-b border-[#333]">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="ml-4 text-gray-400 text-sm font-mono">formatting_logic.py</span>
                    </div>
                    <button id="btn-close-modal" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Code Container -->
                <div id="code-container" class="flex-1 overflow-auto custom-scrollbar bg-[#1e1e1e] text-gray-300 font-mono text-sm p-4 relative">
                    <!-- Lines generated by JS -->
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-3 bg-[#252526] border-t border-[#333] flex justify-between items-center text-xs text-gray-500">
                    <span>Python 3.10</span>
                    <span id="modal-highlight-info">Lines highlighted for Step 1</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // --- Data & Constants ---
        const STEPS = [
            { id: 1, title: "The Raw Data", color: "gray" },
            { id: 2, title: "Alpaca Overview", color: "orange" },
            { id: 3, title: "Alpaca Instruction", color: "orange" },
            { id: 4, title: "Alpaca Input", color: "orange" },
            { id: 5, title: "Alpaca Complete", color: "orange" },
            { id: 6, title: "Chat Overview", color: "teal" },
            { id: 7, title: "Chat Complete", color: "teal" },
            { id: 8, title: "Comparison & Convert", color: "purple" },
        ];

        const CODE_CONTENT = `def format_input(entry):
    """
    Formats an instruction-based training example into the Alpaca-style format.
    """
    instruction_text = (
        f"Below is an instruction that describes a task. "
        f"Write a response that appropriately completes the request."
        f"\\n\\n### Instruction:\\n{entry['instruction']}"
    )
    
    # Add input section only if it's not empty
    input_text = (
        f"\\n\\n### Input:\\n{entry['input']}" if entry["input"] else ""
    )
    
    return instruction_text + input_text

# Example usage with dataset entry
model_input = format_input(data[50])
desired_response = f"\\n\\n### Response:\\n{data[50]['output']}"
full_example = model_input + desired_response
print(full_example)

def format_input_chat(entry):
    """
    Formats an instruction-based training example into Chat-style format.
    """
    user_message = entry['instruction']
    if entry['input']:
        user_message += f" {entry['input']}"
        return f"User: {user_message}"

# Example usage
user_message = data[50]['instruction']
if data[50]['input']:
    user_message += f" {data[50]['input']}"
chat_format = f"User: {user_message}\\nAssistant: {data[50]['output']}"
print(chat_format)

# Example Dataset Entry
data = [
    {
        "instruction": "Identify the correct spelling of the following word.",
        "input": "Ocassion",
        "output": "The correct spelling is 'Occasion.'"
    }
]`;

        const STEP_DETAILS = {
            0: {
                highlightLines: [53, 54, 55, 56, 57, 58, 59],
                explanationTitle: "Understanding the Source Data",
                html: `
                    <p class="mb-4">Before formatting, instruction fine-tuning data exists as structured records with three key fields:</p>
                    <ul class="list-disc pl-5 space-y-2 mb-4">
                        <li><strong>instruction:</strong> Describes the task.</li>
                        <li><strong>input:</strong> Context or data (optional).</li>
                        <li><strong>output:</strong> The expected response.</li>
                    </ul>
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500 text-sm text-blue-800">
                        <strong>Why format?</strong> Models learn sequences. We format this data into patterns to teach the model to distinguish instructions from responses.
                    </div>`
            },
            1: {
                highlightLines: [1, 2, 3, 4, 15],
                explanationTitle: "Alpaca-Style Format: Overview",
                html: `
                    <p class="mb-4">Developed for Stanford's Alpaca, this format uses explicit headers to separate components.</p>
                    <ul class="list-none space-y-2 mb-4">
                        <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-500 mr-2"></span><strong>Instruction:</strong> The task description.</li>
                        <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span><strong>Input:</strong> Optional context/data.</li>
                        <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-teal-500 mr-2"></span><strong>Response:</strong> The answer.</li>
                    </ul>
                    <p class="text-sm text-gray-600">This explicit structure helps the model distinguish "what to do" from "what data to process".</p>`
            },
            2: {
                highlightLines: [6, 7, 8, 9, 10],
                explanationTitle: "Building the Instruction",
                html: `
                    <p class="mb-4">The instruction section consists of two parts:</p>
                    <ol class="list-decimal pl-5 space-y-2 mb-4">
                        <li><strong>Preamble:</strong> A constant system prompt ("Below is an instruction...") that sets the stage.</li>
                        <li><strong>The Task:</strong> Marked by <code>### Instruction:</code>.</li>
                    </ol>
                    <p class="text-sm">The repetition of the preamble helps the model recognize the start of a new task.</p>`
            },
            3: {
                highlightLines: [13, 14, 15],
                explanationTitle: "The Optional Input Section",
                html: `
                    <p class="mb-4">Not all tasks have inputs. The code handles this conditionally:</p>
                    <div class="bg-gray-100 p-2 rounded text-sm font-mono mb-4 border-l-4 border-orange-400">
                        if entry["input"]: add_section()
                    </div>
                    <p>If the input is empty (e.g., "Tell me a joke"), this entire section is skipped to keep the prompt clean.</p>`
            },
            4: {
                highlightLines: [23, 24, 25, 26, 27],
                explanationTitle: "Complete Alpaca Example",
                html: `
                    <p class="mb-4">This is the final string the model sees during training. It learns that:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li><code>### Instruction:</code> means "Do this".</li>
                        <li><code>### Response:</code> means "Start writing here".</li>
                    </ul>
                    <div class="mt-4 bg-teal-50 p-3 rounded-lg border-l-4 border-teal-500 text-sm">
                        <strong>Inference:</strong> When you use the model later, you provide everything <em>except</em> the response text, and the model completes it.
                    </div>`
            },
            5: {
                highlightLines: [30, 31, 32, 33, 34, 35, 36, 37, 38],
                explanationTitle: "Chat-Style Format: Overview",
                html: `
                    <p class="mb-4">Used by models like Phi-3 and ChatGPT, this format mimics a natural dialogue.</p>
                    <ul class="list-none space-y-2 mb-4">
                        <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-teal-500 mr-2"></span><strong>User:</strong> The human (Instruction + Input).</li>
                        <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-purple-500 mr-2"></span><strong>Assistant:</strong> The AI model.</li>
                    </ul>
                    <p class="text-sm">There are no ### markers. The instruction and input are simply combined into the User's message.</p>`
            },
            6: {
                highlightLines: [45, 46, 47, 48, 49],
                explanationTitle: "Complete Chat Example",
                html: `
                    <p class="mb-4">Simple and conversational. The model learns to associate <code>User:</code> with incoming queries and <code>Assistant:</code> with its turn to speak.</p>
                    <p class="text-sm mb-2"><strong>Trade-off:</strong></p>
                    <ul class="text-sm space-y-1">
                        <li>✅ More natural for chatbots.</li>
                        <li>❌ Less explicit boundary between instruction and data.</li>
                    </ul>`
            },
            7: {
                highlightLines: [1, 30],
                explanationTitle: "Key Takeaways",
                html: `
                    <div class="space-y-3">
                        <div class="p-2 bg-orange-50 rounded border-l-4 border-orange-500">
                            <strong>Alpaca = Structure</strong><br/>Best for complex tasks, data transformation, and clear constraints.
                        </div>
                        <div class="p-2 bg-teal-50 rounded border-l-4 border-teal-500">
                            <strong>Chat = Conversation</strong><br/>Best for customer service, tutoring, and natural interactions.
                        </div>
                    </div>`
            }
        };

        // --- State Management ---
        const state = {
            step: 0,
            playing: false,
            timer: null,
            convInst: "Summarize the text.",
            convInput: "Alice was beginning to get very tired of sitting by her sister on the bank.",
            convOutput: "Alice was bored sitting next to her sister."
        };

        // --- DOM Elements ---
        const dom = {
            pills: document.getElementById('step-pills'),
            visual: document.getElementById('visual-container'),
            sidebarTitle: document.getElementById('sidebar-title'),
            sidebarContent: document.getElementById('sidebar-content'),
            stepCounter: document.getElementById('step-counter'),
            playIndicator: document.getElementById('play-indicator'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            btnPlay: document.getElementById('btn-play'),
            iconPlay: document.getElementById('icon-play'),
            iconPause: document.getElementById('icon-pause'),
            btnViewCode: document.getElementById('btn-view-code'),
            viewCodeWrapper: document.getElementById('view-code-wrapper'),
            modal: document.getElementById('code-modal'),
            modalContent: document.getElementById('code-modal-content'),
            btnCloseModal: document.getElementById('btn-close-modal'),
            codeContainer: document.getElementById('code-container'),
            modalHighlightInfo: document.getElementById('modal-highlight-info')
        };

        // --- Render Functions ---

        function init() {
            renderHeader();
            renderApp();
            attachListeners();
        }

        function renderApp() {
            renderHeader(); // Update active pill state
            renderSidebar();
            renderVisual();
            updateControls();
        }

        function renderHeader() {
            dom.pills.innerHTML = STEPS.map((step, idx) => {
                const isActive = idx === state.step;
                const isPast = idx < state.step;
                
                let classes = "px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 hover:scale-105 ";
                if (isActive) {
                    if (step.color === 'orange') classes += "bg-orange-500 text-white shadow-lg shadow-orange-200";
                    else if (step.color === 'teal') classes += "bg-teal-500 text-white shadow-lg shadow-teal-200";
                    else if (step.color === 'purple') classes += "bg-purple-500 text-white shadow-lg shadow-purple-200";
                    else classes += "bg-gray-800 text-white shadow-lg shadow-gray-200";
                } else if (isPast) {
                    classes += "bg-green-100 text-green-600 border border-green-200";
                } else {
                    classes += "bg-gray-100 text-gray-400";
                }

                // Use a checkmark for past steps, number for current/future
                const content = isPast 
                    ? `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>` 
                    : idx + 1;

                return `<button onclick="goToStep(${idx})" class="${classes}" aria-label="Step ${idx+1}: ${step.title}">${content}</button>`;
            }).join('');
        }

        function renderSidebar() {
            const details = STEP_DETAILS[state.step];
            const meta = STEPS[state.step];

            dom.stepCounter.textContent = `Step ${state.step + 1} of ${STEPS.length}`;
            dom.sidebarTitle.textContent = details.explanationTitle || meta.title;
            dom.sidebarContent.innerHTML = details.html;

            // Show/Hide "View Implementation" button (hidden on last step)
            if (state.step < 7) {
                dom.viewCodeWrapper.classList.remove('hidden');
            } else {
                dom.viewCodeWrapper.classList.add('hidden');
            }
        }

        function updateControls() {
            dom.btnPrev.disabled = state.step === 0;
            dom.btnNext.disabled = state.step === STEPS.length - 1;
            
            // Play/Pause icon toggle
            if (state.playing) {
                dom.iconPlay.classList.add('hidden');
                dom.iconPause.classList.remove('hidden');
                dom.btnPlay.classList.replace('bg-indigo-600', 'bg-red-50');
                dom.btnPlay.classList.replace('text-white', 'text-red-500');
                dom.playIndicator.classList.add('animate-pulse-custom', 'bg-green-500');
                dom.playIndicator.classList.remove('bg-gray-300');
            } else {
                dom.iconPlay.classList.remove('hidden');
                dom.iconPause.classList.add('hidden');
                dom.btnPlay.classList.replace('bg-red-50', 'bg-indigo-600');
                dom.btnPlay.classList.replace('text-red-500', 'text-white');
                dom.playIndicator.classList.remove('animate-pulse-custom', 'bg-green-500');
                dom.playIndicator.classList.add('bg-gray-300');
            }
        }

        function renderVisual() {
            // If we are on Step 7, special handling to prevent losing focus if inputs already exist
            if (state.step === 7 && document.getElementById('converter-ui')) {
                // Just update the outputs
                updateConverterOutputs();
                return;
            }

            let html = '';
            
            // Common Card Wrapper
            const wrapCard = (color, content, title="") => `
                <div class="bg-white rounded-xl border border-${color}-200 shadow-lg shadow-${color}-100 p-6 w-full animate-fade-in">
                    ${title ? `<h3 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2">${title}</h3>` : ''}
                    ${content}
                </div>`;

            switch (state.step) {
                case 0: // Raw Data
                    html = wrapCard('gray', `
                        <pre class="font-mono text-sm text-gray-700 whitespace-pre-wrap">
<span class="text-purple-600">{</span>
<span class="text-red-600">  "instruction"</span>: <span class="text-blue-600">"Identify the correct spelling of the following word."</span>,
<span class="text-red-600">  "input"</span>: <span class="text-blue-600">"Ocassion"</span>,
<span class="text-red-600">  "output"</span>: <span class="text-blue-600">"The correct spelling is 'Occasion.'"</span>
<span class="text-purple-600">}</span></pre>`, "Raw JSON Data");
                    break;

                case 1: // Alpaca Overview
                    html = `
                    <div class="space-y-4 font-mono text-sm animate-fade-in">
                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400 text-gray-500">
                          PREAMBLE: Below is an instruction...
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500 text-orange-900">
                          ### Instruction:<br/>&lt;Task Description&gt;
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 text-blue-900">
                          ### Input:<br/>&lt;Optional Context&gt;
                        </div>
                        <div class="bg-teal-50 p-4 rounded-lg border-l-4 border-teal-500 text-teal-900">
                          ### Response:<br/>&lt;Expected Output&gt;
                        </div>
                    </div>`;
                    break;

                case 2: // Building Instruction
                    html = `
                    <div class="space-y-2 font-mono text-sm animate-fade-in">
                         <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400 text-gray-500 opacity-50">
                          Below is an instruction that describes a task. Write a response that appropriately completes the request.
                        </div>
                        <div class="flex flex-col items-center text-purple-500 text-2xl py-2">↓</div>
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500 shadow-lg transform scale-105 transition-transform">
                          <span class="font-bold text-orange-600 block mb-2">### Instruction:</span>
                          <span class="text-gray-800">Identify the correct spelling of the following word.</span>
                        </div>
                    </div>`;
                    break;

                case 3: // Building Input
                    html = `
                    <div class="space-y-2 font-mono text-sm animate-fade-in">
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500 opacity-50">
                          ### Instruction: ...
                        </div>
                        <div class="flex justify-around items-start pt-4">
                          <div class="flex flex-col items-center flex-1">
                             <span class="text-xs text-gray-500 mb-2">If input exists</span>
                             <div class="text-purple-500 text-xl mb-2">↓</div>
                             <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-500 w-full shadow-md">
                                <span class="font-bold text-blue-600 block">### Input:</span>
                                Ocassion
                             </div>
                          </div>
                          <div class="flex flex-col items-center flex-1 opacity-40">
                             <span class="text-xs text-gray-500 mb-2">If input is empty</span>
                             <div class="text-gray-400 text-xl mb-2">↓</div>
                             <div class="bg-gray-50 p-3 rounded border border-dashed border-gray-300 w-full text-center text-gray-400 italic">
                                (Skipped)
                             </div>
                          </div>
                        </div>
                    </div>`;
                    break;

                case 4: // Alpaca Complete
                    html = `
                    <div class="bg-white border-2 border-orange-100 rounded-xl shadow-xl overflow-hidden font-mono text-sm animate-fade-in">
                        <div class="bg-gray-50 p-4 text-gray-500 text-xs border-b border-gray-100">
                          Below is an instruction that describes a task. Write a response that appropriately completes the request.
                        </div>
                        <div class="p-4 space-y-4">
                          <div>
                            <span class="text-orange-600 font-bold block">### Instruction:</span>
                            <span class="text-gray-800">Identify the correct spelling of the following word.</span>
                          </div>
                          <div>
                            <span class="text-blue-600 font-bold block">### Input:</span>
                            <span class="text-gray-800">Ocassion</span>
                          </div>
                          <div class="bg-teal-50 -mx-4 px-4 py-2 border-l-4 border-teal-400">
                            <span class="text-teal-600 font-bold block">### Response:</span>
                            <span class="text-gray-800">The correct spelling is 'Occasion.'</span>
                          </div>
                        </div>
                    </div>`;
                    break;
                
                case 5: // Chat Overview
                    html = `
                    <div class="space-y-6 animate-fade-in">
                         <div class="flex items-start">
                            <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 mr-3 flex-shrink-0">
                              <span class="text-xs font-bold">U</span>
                            </div>
                            <div class="bg-teal-50 p-4 rounded-2xl rounded-tl-none border border-teal-100 flex-1 shadow-sm">
                              <div class="font-bold text-teal-700 text-xs mb-1 uppercase">User</div>
                              <div class="font-mono text-sm text-gray-600">&lt;Instruction&gt; &lt;Input&gt;</div>
                            </div>
                         </div>
                         <div class="flex items-start justify-end">
                            <div class="bg-purple-50 p-4 rounded-2xl rounded-tr-none border border-purple-100 flex-1 shadow-sm text-right">
                              <div class="font-bold text-purple-700 text-xs mb-1 uppercase">Assistant</div>
                              <div class="font-mono text-sm text-gray-600">&lt;Output&gt;</div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 ml-3 flex-shrink-0">
                              <span class="text-xs font-bold">A</span>
                            </div>
                         </div>
                    </div>`;
                    break;

                case 6: // Chat Complete
                    html = `
                    <div class="space-y-6 font-sans animate-fade-in">
                         <div class="flex items-start">
                            <div class="w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center text-white mr-3 shadow-md flex-shrink-0">
                              <span class="text-xs font-bold">U</span>
                            </div>
                            <div class="bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 shadow-md flex-1">
                              <span class="font-bold text-teal-600 text-xs block mb-1">USER</span>
                              <p class="text-gray-700">Identify the correct spelling of the following word. Ocassion</p>
                            </div>
                         </div>
                         <div class="flex items-start flex-row-reverse">
                            <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white ml-3 shadow-md flex-shrink-0">
                              <span class="text-xs font-bold">AI</span>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-2xl rounded-tr-none border border-purple-100 shadow-md flex-1 text-right">
                              <span class="font-bold text-purple-600 text-xs block mb-1">ASSISTANT</span>
                              <p class="text-gray-800">The correct spelling is 'Occasion.'</p>
                            </div>
                         </div>
                    </div>`;
                    break;

                case 7: // Converter
                    html = `
                    <div id="converter-ui" class="flex flex-col h-full animate-fade-in w-full">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Instruction</label>
                            <input id="in-inst" value="${state.convInst}" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                          </div>
                          <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Input (Optional)</label>
                            <input id="in-input" value="${state.convInput}" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                          </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
                           <!-- Alpaca Output -->
                           <div class="border border-orange-200 rounded-lg bg-orange-50/30 p-3 flex flex-col">
                              <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-orange-600 uppercase">Alpaca Format</span>
                                <span class="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded-full">Structured</span>
                              </div>
                              <div id="out-alpaca" class="flex-1 bg-white border border-gray-200 rounded p-2 text-xs font-mono overflow-auto whitespace-pre-wrap h-32 md:h-auto custom-scrollbar"></div>
                           </div>
                           <!-- Chat Output -->
                           <div class="border border-teal-200 rounded-lg bg-teal-50/30 p-3 flex flex-col">
                              <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-teal-600 uppercase">Chat Format</span>
                                <span class="text-xs bg-teal-200 text-teal-800 px-2 py-0.5 rounded-full">Conversational</span>
                              </div>
                              <div id="out-chat" class="flex-1 bg-white border border-gray-200 rounded p-2 text-xs font-mono overflow-auto whitespace-pre-wrap h-32 md:h-auto custom-scrollbar"></div>
                           </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-100 text-center">
                          <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Output (Answer)</label>
                            <input id="in-output" value="${state.convOutput}" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                          </div>
                        </div>
                    </div>`;
                    break;
            }

            dom.visual.innerHTML = html;

            if (state.step === 7) {
                // Attach converter listeners specifically
                document.getElementById('in-inst').addEventListener('input', (e) => { state.convInst = e.target.value; updateConverterOutputs(); });
                document.getElementById('in-input').addEventListener('input', (e) => { state.convInput = e.target.value; updateConverterOutputs(); });
                document.getElementById('in-output').addEventListener('input', (e) => { state.convOutput = e.target.value; updateConverterOutputs(); });
                updateConverterOutputs();
            }
        }

        function updateConverterOutputs() {
            const outAlpaca = document.getElementById('out-alpaca');
            const outChat = document.getElementById('out-chat');
            if(!outAlpaca || !outChat) return;

            // Render Alpaca
            let alpacaHTML = `<span class="text-gray-400">Below is an instruction that describes a task. Write a response that appropriately completes the request.</span>\n\n<span class="text-orange-600 font-bold">### Instruction:</span>\n${state.convInst}\n\n`;
            if (state.convInput.trim()) {
                alpacaHTML += `<span class="text-blue-600 font-bold">### Input:</span>\n${state.convInput}\n\n`;
            }
            alpacaHTML += `<span class="text-teal-600 font-bold">### Response:</span>\n${state.convOutput}`;
            outAlpaca.innerHTML = alpacaHTML;

            // Render Chat
            let chatHTML = `<span class="text-teal-600 font-bold">User:</span> ${state.convInst}`;
            if (state.convInput.trim()) {
                chatHTML += ` ${state.convInput}`;
            }
            chatHTML += `\n<span class="text-purple-600 font-bold">Assistant:</span> ${state.convOutput}`;
            outChat.innerHTML = chatHTML;
        }

        function toggleCodeModal(show) {
            if (show) {
                // Generate Code HTML with line numbers
                const lines = CODE_CONTENT.split('\n');
                const highlightLines = STEP_DETAILS[state.step]?.highlightLines || [];
                const codeHtml = lines.map((line, i) => {
                    const lineNum = i + 1;
                    const isHighlighted = highlightLines.includes(lineNum);
                    const bgClass = isHighlighted ? 'bg-indigo-900/30 border-l-4 border-indigo-400 -mx-4 px-4' : '';
                    return `
                        <div class="flex ${bgClass} py-0.5">
                            <span class="w-8 text-gray-600 select-none text-right mr-4 shrink-0">${lineNum}</span>
                            <span class="whitespace-pre">${escapeHtml(line)}</span>
                        </div>`;
                }).join('');
                
                dom.codeContainer.innerHTML = codeHtml;
                dom.modalHighlightInfo.textContent = `Lines highlighted for Step ${state.step + 1}`;
                
                dom.modal.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    dom.modal.classList.remove('opacity-0');
                    dom.modalContent.classList.remove('scale-95');
                }, 10);

                // Scroll to first highlight
                if(highlightLines.length > 0) {
                    const lineEl = dom.codeContainer.children[highlightLines[0] - 1];
                    if(lineEl) {
                        setTimeout(() => lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
                    }
                }
            } else {
                dom.modal.classList.add('opacity-0');
                dom.modalContent.classList.add('scale-95');
                setTimeout(() => {
                    dom.modal.classList.add('hidden');
                }, 300);
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- Interaction Logic ---

        function goToStep(idx) {
            if (idx >= 0 && idx < STEPS.length) {
                state.step = idx;
                state.playing = false; // Stop auto-play on manual interaction
                renderApp();
            }
        }

        function nextStep() { goToStep(state.step + 1); }
        function prevStep() { goToStep(state.step - 1); }

        function togglePlay() {
            state.playing = !state.playing;
            updateControls();
            
            if (state.playing) {
                if (state.timer) clearInterval(state.timer);
                state.timer = setInterval(() => {
                    if (state.step < STEPS.length - 1) {
                        state.step++;
                        renderApp();
                    } else {
                        state.playing = false;
                        clearInterval(state.timer);
                        updateControls();
                    }
                }, 3500);
            } else {
                clearInterval(state.timer);
            }
        }

        function attachListeners() {
            dom.btnPrev.addEventListener('click', prevStep);
            dom.btnNext.addEventListener('click', nextStep);
            dom.btnPlay.addEventListener('click', togglePlay);
            dom.btnViewCode.addEventListener('click', () => toggleCodeModal(true));
            dom.btnCloseModal.addEventListener('click', () => toggleCodeModal(false));
            
            // Close modal on outside click
            dom.modal.addEventListener('click', (e) => {
                if(e.target === dom.modal) toggleCodeModal(false);
            });

            // Keyboard Nav
            document.addEventListener('keydown', (e) => {
                // Ignore keyboard nav if focused on inputs
                if(e.target.tagName === 'INPUT') return;

                if (e.key === 'ArrowRight') nextStep();
                if (e.key === 'ArrowLeft') prevStep();
                if (e.key === ' ') {
                    e.preventDefault();
                    togglePlay();
                }
                if (e.key === 'Escape') toggleCodeModal(false);
            });
        }

        // Start
        init();

    </script>
</body>
</html>