<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Differentiation & The Chain Rule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #fafbff 0%, #f5f7ff 100%);
            color: #64748b;
        }

        .font-math {
            font-family: 'Noto Serif', 'Georgia', serif;
            font-style: italic;
        }

        /* SVG Styles */
        svg {
            overflow: visible;
        }

        /* Forward Edges */
        .edge-forward {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 2;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        .edge-forward.active {
            stroke: #8b5cf6;
        }

        /* Backward Edges (Gradients) */
        .edge-backward {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 10, 4;
            /* Dashed style for backward */
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Gradient Colors */
        .grad-loss {
            stroke: #ef4444;
        }

        /* Red */
        .grad-act {
            stroke: #14b8a6;
        }

        /* Teal */
        .grad-bias {
            stroke: #3b82f6;
        }

        /* Blue */
        .grad-weight {
            stroke: #22c55e;
        }

        /* Green */

        /* Animation Classes */
        .animate-draw {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 0.8s forwards ease-out;
        }

        @keyframes drawLine {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Node Styles */
        .node-rect,
        .node-circle {
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.05));
        }

        .node-group {
            cursor: pointer;
        }

        /* Pulse Animation for Nodes receiving gradient */
        .pulse-node {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 8px currentColor);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Input Controls */
        .input-pill:focus-within {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Tooltip */
        #tooltip {
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-out;
            position: fixed;
            z-index: 50;
        }

        /* Equation Builder Items */
        .eq-term {
            opacity: 0.3;
            transform: translateY(5px);
            transition: all 0.3s ease;
        }

        .eq-term.active {
            opacity: 1;
            transform: translateY(0);
            font-weight: bold;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        warm: { bg: '#fff7ed', border: '#fdba74', text: '#c2410c' },
                        cool: { bg: '#ecfdf5', border: '#6ee7b7', text: '#047857' },
                        target: { bg: '#fdf4ff', border: '#f0abfc', text: '#a21caf' },
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen flex flex-col items-center p-4 md:p-6">

    <!-- Header -->
    <header class="text-center mb-6 max-w-3xl">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">Automatic Differentiation & The Chain Rule</h1>
        <p class="text-slate-500">Visualizing how gradients flow backward through the computational graph to update
            parameters.</p>
    </header>

    <!-- Main Layout -->
    <div
        class="bg-white rounded-2xl shadow-xl border border-slate-100 w-full max-w-7xl overflow-hidden flex flex-col md:flex-row">

        <!-- LEFT SIDEBAR: Controls & Inputs -->
        <div class="w-full md:w-72 bg-slate-50 border-r border-slate-200 flex flex-col shrink-0">

            <!-- Action Buttons -->
            <div class="p-5 border-b border-slate-200 bg-white">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Workflow Controls</h2>
                <div class="space-y-3">
                    <button onclick="runForwardPass()"
                        class="w-full py-2.5 px-4 bg-white border border-slate-200 text-slate-700 rounded-xl hover:border-indigo-300 hover:bg-indigo-50 font-medium transition-all flex items-center justify-center gap-2 shadow-sm">
                        <i class="fa-solid fa-arrow-right text-indigo-500"></i> Run Forward Pass
                    </button>
                    <button onclick="runBackwardPass()"
                        class="w-full py-2.5 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-medium transition-all flex items-center justify-center gap-2 shadow-md">
                        <i class="fa-solid fa-arrow-left"></i> Run Backward Pass
                    </button>
                    <div class="flex gap-2">
                        <button onclick="stepAnimation()"
                            class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 font-medium text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-shoe-prints"></i> Step
                        </button>
                        <button onclick="resetAll()"
                            class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-500 rounded-xl hover:bg-slate-50 font-medium text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-rotate-left"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Parameters -->
            <div class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Parameters & Inputs</h3>
                <div class="space-y-4">
                    <!-- x1 -->
                    <div class="input-pill bg-warm-bg border border-warm-border rounded-lg p-3 relative group">
                        <label class="text-xs font-math text-warm-text font-bold block mb-1">x₁ (Input)</label>
                        <input type="number" id="input_x1" value="1.1" step="0.1"
                            class="w-full bg-transparent font-mono text-warm-text focus:outline-none"
                            oninput="updateValues(false)">
                    </div>
                    <!-- w1 -->
                    <div class="input-pill bg-warm-bg border-warm-border border rounded-lg p-3">
                        <label class="text-xs font-math text-warm-text font-bold block mb-1">w₁ (Weight)</label>
                        <input type="number" id="input_w1" value="2.2" step="0.1"
                            class="w-full bg-transparent font-mono text-warm-text focus:outline-none"
                            oninput="updateValues(false)">
                        <div id="w1-update" class="text-[10px] text-green-600 font-mono mt-1 h-4 transition-all"></div>
                    </div>
                    <!-- b -->
                    <div class="input-pill bg-warm-bg border-warm-border border rounded-lg p-3">
                        <label class="text-xs font-math text-warm-text font-bold block mb-1">b (Bias)</label>
                        <input type="number" id="input_b" value="0.0" step="0.1"
                            class="w-full bg-transparent font-mono text-warm-text focus:outline-none"
                            oninput="updateValues(false)">
                        <div id="b-update" class="text-[10px] text-blue-600 font-mono mt-1 h-4 transition-all"></div>
                    </div>
                    <!-- y -->
                    <div class="input-pill bg-target-bg border-target-border border rounded-lg p-3">
                        <label class="text-xs font-math text-target-text font-bold block mb-1">y (Target)</label>
                        <input type="number" id="input_y" value="1.0" step="1.0" min="0" max="1"
                            class="w-full bg-transparent font-mono text-target-text focus:outline-none"
                            oninput="updateValues(false)">
                    </div>

                    <!-- Learning Rate -->
                    <div class="pt-4 border-t border-slate-200">
                        <label class="text-xs font-bold text-slate-500 block mb-2">Learning Rate (η): <span
                                id="lr-val">0.1</span></label>
                        <input type="range" id="lr-slider" min="0.01" max="1.0" step="0.01" value="0.1"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                            oninput="document.getElementById('lr-val').innerText=this.value; updateParamPreviews()">
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER: Visualization Area -->
        <div class="flex-1 flex flex-col bg-slate-50/30 relative">

            <!-- Graph Legend -->
            <div
                class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-lg border border-slate-200 shadow-sm text-xs z-10 pointer-events-none hidden lg:block">
                <div class="font-bold text-slate-500 mb-2 uppercase tracking-wider">Gradient Flow</div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-0.5 bg-red-500 border-t-2 border-dashed border-red-500"></div> <span
                            class="text-slate-600">Loss</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-0.5 bg-teal-500 border-t-2 border-dashed border-teal-500"></div> <span
                            class="text-slate-600">Activation</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-0.5 bg-blue-500 border-t-2 border-dashed border-blue-500"></div> <span
                            class="text-slate-600">Bias</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-0.5 bg-green-500 border-t-2 border-dashed border-green-500"></div> <span
                            class="text-slate-600">Weight</span>
                    </div>
                </div>
            </div>

            <!-- SVG Container -->
            <div class="flex-1 overflow-auto flex items-center justify-center p-4 min-h-[450px]">
                <svg id="graphSvg" width="850" height="420" viewBox="0 0 850 420">
                    <defs>
                        <!-- Filters -->
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.1" />
                        </filter>
                        <!-- Markers -->
                        <marker id="arrow-fwd" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1" />
                        </marker>
                        <marker id="arrow-back-red" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="10 0, 0 3.5, 10 7" fill="#ef4444" />
                        </marker>
                        <marker id="arrow-back-teal" markerWidth="10" markerHeight="7" refX="0" refY="3.5"
                            orient="auto">
                            <polygon points="10 0, 0 3.5, 10 7" fill="#14b8a6" />
                        </marker>
                        <marker id="arrow-back-blue" markerWidth="10" markerHeight="7" refX="0" refY="3.5"
                            orient="auto">
                            <polygon points="10 0, 0 3.5, 10 7" fill="#3b82f6" />
                        </marker>
                        <marker id="arrow-back-green" markerWidth="10" markerHeight="7" refX="0" refY="3.5"
                            orient="auto">
                            <polygon points="10 0, 0 3.5, 10 7" fill="#22c55e" />
                        </marker>
                    </defs>

                    <!-- Layers -->
                    <g id="layer-edges-fwd"></g>
                    <g id="layer-edges-back"></g>
                    <g id="layer-nodes"></g>
                    <g id="layer-labels-back"></g> <!-- Partial derivatives labels -->
                </svg>
            </div>

            <!-- Bottom Panel: Logic & Details -->
            <div class="bg-white border-t border-slate-200 p-6 min-h-[200px]">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chain Rule Builder -->
                    <div class="bg-slate-50 rounded-xl p-5 border border-slate-100">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Chain Rule
                            Construction (Gradient for w₁)</h3>
                        <div class="flex items-center gap-2 flex-wrap font-math text-lg md:text-xl min-h-[40px]"
                            id="chain-equation">
                            <span class="text-slate-300 italic">Run backward pass to build equation...</span>
                        </div>
                        <div class="mt-4 text-sm text-slate-600 font-mono bg-white p-2 rounded border border-slate-100 min-h-[36px]"
                            id="chain-calc">
                            <!-- Numeric breakdown goes here -->
                        </div>
                    </div>

                    <!-- Computed Values Table -->
                    <div class="flex flex-col">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                            <span>Forward Values</span>
                            <span class="text-indigo-600 cursor-help" title="Computed left-to-right">●</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-2 text-center text-sm font-mono mb-4">
                            <div class="bg-cool-bg border border-cool-border text-cool-text rounded p-1">
                                <div class="text-[10px] opacity-70">u</div>
                                <div id="val-u" class="font-bold">--</div>
                            </div>
                            <div class="bg-cool-bg border border-cool-border text-cool-text rounded p-1">
                                <div class="text-[10px] opacity-70">z</div>
                                <div id="val-z" class="font-bold">--</div>
                            </div>
                            <div class="bg-cool-bg border border-cool-border text-cool-text rounded p-1">
                                <div class="text-[10px] opacity-70">a</div>
                                <div id="val-a" class="font-bold">--</div>
                            </div>
                            <div class="bg-cool-bg border border-cool-border text-cool-text rounded p-1">
                                <div class="text-[10px] opacity-70">loss</div>
                                <div id="val-loss" class="font-bold">--</div>
                            </div>
                        </div>

                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                            <span>Computed Gradients</span>
                            <span class="text-red-500 cursor-help" title="Computed right-to-left">●</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-2 text-center text-sm font-mono">
                            <div
                                class="bg-slate-100 border border-slate-200 text-slate-700 rounded p-2 flex justify-between px-4">
                                <span class="font-math">∂L/∂w₁</span>
                                <span id="grad-w1" class="font-bold">--</span>
                            </div>
                            <div
                                class="bg-slate-100 border border-slate-200 text-slate-700 rounded p-2 flex justify-between px-4">
                                <span class="font-math">∂L/∂b</span>
                                <span id="grad-b" class="font-bold">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Educational Tooltip (Fixed position relative to element logic handled in JS) -->
    <div id="tooltip"
        class="bg-slate-800 text-white p-4 rounded-lg shadow-2xl max-w-xs transform -translate-x-1/2 -translate-y-full mb-3">
        <div id="tt-header" class="font-bold text-indigo-300 mb-1 border-b border-slate-600 pb-1">Header</div>
        <div id="tt-sub" class="font-mono text-xs text-yellow-300 mb-2">Formula</div>
        <div id="tt-desc" class="text-sm leading-relaxed text-slate-200">Description text.</div>
    </div>

    <script>
        // --- Constants & Layout Config ---
        const NODE_W = 80;
        const NODE_H = 40;
        const OP_R = 25;

        // Node Positions (x, y)
        const POS = {
            x1: { x: 100, y: 300 },
            w1: { x: 100, y: 180 },
            b: { x: 100, y: 60 }, // Bias moved up for better arc clearance
            y: { x: 750, y: 300 },

            mul: { x: 250, y: 240 },
            u: { x: 350, y: 240 },

            add: { x: 480, y: 240 },
            z: { x: 580, y: 240 },

            sig: { x: 680, y: 240 },
            a: { x: 750, y: 180 },

            lossOp: { x: 820, y: 240 }, // Reordered slightly for layout
            loss: { x: 820, y: 120 }
        };

        // Redefine positions for a cleaner linear flow with bias on top
        const LAYOUT = {
            x1: { x: 80, y: 280, type: 'input', label: 'x₁' },
            w1: { x: 80, y: 200, type: 'param', label: 'w₁' },
            mul: { x: 200, y: 240, type: 'op', label: '×' },
            u: { x: 280, y: 240, type: 'val', label: 'u' },

            b: { x: 360, y: 140, type: 'param', label: 'b' },
            add: { x: 400, y: 240, type: 'op', label: '+' },
            z: { x: 480, y: 240, type: 'val', label: 'z' },

            sig: { x: 560, y: 240, type: 'op', label: 'σ' },
            a: { x: 640, y: 240, type: 'val', label: 'a' },

            y: { x: 640, y: 340, type: 'target', label: 'y' },
            lossOp: { x: 740, y: 240, type: 'op', label: 'L' },
            loss: { x: 820, y: 240, type: 'val', label: 'loss' }
        };

        const EDGES_FWD = [
            ['w1', 'mul'], ['x1', 'mul'],
            ['mul', 'u'],
            ['u', 'add'], ['b', 'add'],
            ['add', 'z'],
            ['z', 'sig'],
            ['sig', 'a'],
            ['a', 'lossOp'], ['y', 'lossOp'],
            ['lossOp', 'loss']
        ];

        // [StartNode, EndNode, ControlHeightOffset, ColorClass, Label, LabelOffset]
        // Start/End are reversed for logic (Flow is End->Start) but visual drawing is Start->End
        // For gradient flow: We draw FROM loss TO parameter
        const EDGES_BACK = [
            { id: 'grad_loss', from: 'loss', to: 'a', h: -60, cls: 'grad-loss', label: '∂L/∂a' },
            { id: 'grad_act', from: 'a', to: 'z', h: -60, cls: 'grad-act', label: 'da/dz' },
            { id: 'grad_bias', from: 'z', to: 'b', h: -60, cls: 'grad-bias', label: '∂z/∂b' },
            { id: 'grad_pre', from: 'z', to: 'u', h: 50, cls: 'grad-weight', label: '∂z/∂u' }, // Draw below line to avoid bias crossing
            { id: 'grad_w', from: 'u', to: 'w1', h: -50, cls: 'grad-weight', label: '∂u/∂w₁' }
        ];

        // --- State ---
        let state = {
            x1: 1.1, w1: 2.2, b: 0.0, y: 1.0,
            u: 0, z: 0, a: 0, loss: 0,
            grads: { dL_da: 0, da_dz: 0, dz_db: 0, dz_du: 0, du_dw1: 0, dL_dw1: 0, dL_db: 0 },
            isAnimating: false,
            stepIndex: 0
        };

        const STEPS = [
            { id: 'start', desc: "Start Backward Pass" },
            { id: 'grad_loss', eq: '<span class="text-red-500">∂L/∂a</span>', text: 'Loss gradient w.r.t prediction' },
            { id: 'grad_act', eq: ' × <span class="text-teal-500">da/dz</span>', text: 'Backprop through Sigmoid' },
            { id: 'grad_bias', eq: '', text: 'Branch to Bias' }, // Bias branch
            { id: 'grad_pre', eq: ' × <span class="text-green-600">∂z/∂u</span>', text: 'Backprop through Addition' },
            { id: 'grad_w', eq: ' × <span class="text-green-500">∂u/∂w₁</span>', text: 'Backprop through Multiplication' },
            { id: 'end', desc: "Parameters Updated" }
        ];

        let animTimer;

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            renderGraph();
            updateValues(true);
        });

        // --- Core Logic ---
        function sigmoid(z) { return 1 / (1 + Math.exp(-z)); }
        function bce(a, y) {
            const eps = 1e-7;
            const as = Math.max(eps, Math.min(1 - eps, a));
            return -(y * Math.log(as) + (1 - y) * Math.log(1 - as));
        }

        function updateValues(initial = false) {
            if (!initial) {
                state.x1 = parseFloat(document.getElementById('input_x1').value);
                state.w1 = parseFloat(document.getElementById('input_w1').value);
                state.b = parseFloat(document.getElementById('input_b').value);
                state.y = parseFloat(document.getElementById('input_y').value);
            }

            // Forward
            state.u = state.w1 * state.x1;
            state.z = state.u + state.b;
            state.a = sigmoid(state.z);
            state.loss = bce(state.a, state.y);

            // Backward
            const eps = 1e-7;
            const as = Math.max(eps, Math.min(1 - eps, state.a));
            state.grads.dL_da = (as - state.y) / (as * (1 - as));
            state.grads.da_dz = state.a * (1 - state.a);
            state.grads.dz_du = 1;
            state.grads.dz_db = 1;
            state.grads.du_dw1 = state.x1;

            // Final Chain
            state.grads.dL_dw1 = state.grads.dL_da * state.grads.da_dz * state.grads.dz_du * state.grads.du_dw1;
            state.grads.dL_db = state.grads.dL_da * state.grads.da_dz * state.grads.dz_db;

            // Simplified form checks (Analytical vs Numerical)
            // Analytical dL/dz = a - y
            // dL/dw = x(a-y)
            // dL/db = (a-y)
            const analytical_grad_w = state.x1 * (state.a - state.y);
            const analytical_grad_b = (state.a - state.y);

            // Update UI Displays
            document.getElementById('val-u').innerText = state.u.toFixed(2);
            document.getElementById('val-z').innerText = state.z.toFixed(2);
            document.getElementById('val-a').innerText = state.a.toFixed(3);
            document.getElementById('val-loss').innerText = state.loss.toFixed(3);

            document.getElementById('grad-w1').innerText = analytical_grad_w.toFixed(4);
            document.getElementById('grad-b').innerText = analytical_grad_b.toFixed(4);

            updateParamPreviews();
        }

        function updateParamPreviews() {
            const lr = parseFloat(document.getElementById('lr-slider').value);
            const gw = state.x1 * (state.a - state.y);
            const gb = (state.a - state.y);

            const new_w = state.w1 - (lr * gw);
            const new_b = state.b - (lr * gb);

            // Show update direction
            const w_arrow = gw > 0 ? '↓' : '↑';
            const b_arrow = gb > 0 ? '↓' : '↑';

            document.getElementById('w1-update').innerText = `New: ${new_w.toFixed(2)} (${w_arrow})`;
            document.getElementById('b-update').innerText = `New: ${new_b.toFixed(2)} (${b_arrow})`;
        }

        // --- Rendering ---
        function renderGraph() {
            const svg = document.getElementById('graphSvg');
            const gFwd = document.getElementById('layer-edges-fwd');
            const gBack = document.getElementById('layer-edges-back');
            const gNodes = document.getElementById('layer-nodes');
            const gLabels = document.getElementById('layer-labels-back');

            // 1. Draw Forward Edges
            EDGES_FWD.forEach(([startId, endId]) => {
                const s = LAYOUT[startId];
                const e = LAYOUT[endId];

                // Adjust Start/End points based on shapes
                let sx = s.x + (s.type === 'op' ? OP_R : 40);
                let sy = s.y;
                let ex = e.x - (e.type === 'op' ? OP_R : 40);
                let ey = e.y;

                // Simple path for now, maybe curved if y diff
                let d = `M ${sx} ${sy} L ${ex} ${ey}`;

                // Special case for y and b curving
                if (startId === 'b') {
                    d = `M ${sx} ${sy} C ${sx + 20} ${sy}, ${ex - 20} ${ey}, ${ex} ${ey}`;
                } else if (startId === 'y') {
                    d = `M ${sx} ${sy} C ${sx + 20} ${sy}, ${ex - 20} ${ey}, ${ex} ${ey}`;
                }

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", d);
                path.setAttribute("class", "edge-forward");
                path.setAttribute("marker-end", "url(#arrow-fwd)");
                gFwd.appendChild(path);
            });

            // 2. Draw Nodes
            Object.keys(LAYOUT).forEach(key => {
                const n = LAYOUT[key];
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "node-group");
                g.setAttribute("transform", `translate(${n.x}, ${n.y})`);
                g.setAttribute("id", `node-${key}`);

                // Hover Events
                g.addEventListener('mouseenter', () => showTooltip(g, key));
                g.addEventListener('mouseleave', hideTooltip);

                if (n.type === 'op') {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("r", OP_R);
                    circle.setAttribute("fill", "#c4b5fd");
                    circle.setAttribute("stroke", "#8b5cf6");
                    circle.setAttribute("stroke-width", "2");
                    circle.setAttribute("class", "node-circle");
                    g.appendChild(circle);

                    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    txt.setAttribute("text-anchor", "middle");
                    txt.setAttribute("dy", "5");
                    txt.setAttribute("fill", "white");
                    txt.setAttribute("font-weight", "bold");
                    txt.textContent = n.label;
                    g.appendChild(txt);
                } else {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", -40);
                    rect.setAttribute("y", -20);
                    rect.setAttribute("width", 80);
                    rect.setAttribute("height", 40);
                    rect.setAttribute("rx", 8);
                    rect.setAttribute("class", "node-rect");

                    if (n.type === 'param' || n.type === 'input') {
                        rect.setAttribute("fill", "#fff7ed");
                        rect.setAttribute("stroke", "#fdba74");
                    } else if (n.type === 'target') {
                        rect.setAttribute("fill", "#fdf4ff");
                        rect.setAttribute("stroke", "#f0abfc");
                    } else {
                        rect.setAttribute("fill", "#ecfdf5");
                        rect.setAttribute("stroke", "#6ee7b7");
                    }
                    rect.setAttribute("stroke-width", "1");
                    g.appendChild(rect);

                    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    txt.setAttribute("text-anchor", "middle");
                    txt.setAttribute("dy", "5");
                    txt.setAttribute("font-size", "14");
                    txt.setAttribute("font-weight", "600");
                    txt.setAttribute("fill", "#475569");
                    txt.textContent = n.label;
                    g.appendChild(txt);
                }
                gNodes.appendChild(g);
            });

            // 3. Draw Backward Edges (Initially Hidden)
            EDGES_BACK.forEach(edge => {
                const s = LAYOUT[edge.from];
                const e = LAYOUT[edge.to];

                // Arc logic
                const sx = s.x; // Start center top/bottom
                const sy = edge.h < 0 ? s.y - 20 : s.y + 20;
                const ex = e.x;
                const ey = edge.h < 0 ? e.y - 20 : e.y + 20;

                const midX = (sx + ex) / 2;
                const midY = Math.min(sy, ey) + edge.h; // Curve height

                const d = `M ${sx} ${sy} Q ${midX} ${midY} ${ex} ${ey}`;

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", d);
                path.setAttribute("class", `edge-backward ${edge.cls}`);
                path.setAttribute("id", edge.id);

                // Color specific marker
                let marker = "url(#arrow-fwd)";
                if (edge.cls.includes('loss')) marker = "url(#arrow-back-red)";
                if (edge.cls.includes('act')) marker = "url(#arrow-back-teal)";
                if (edge.cls.includes('bias')) marker = "url(#arrow-back-blue)";
                if (edge.cls.includes('weight')) marker = "url(#arrow-back-green)";
                path.setAttribute("marker-end", marker);

                gBack.appendChild(path);

                // Label on curve
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", midX);
                txt.setAttribute("y", midY - (edge.h < 0 ? 10 : -20));
                txt.setAttribute("text-anchor", "middle");
                txt.setAttribute("class", "font-math text-xs fill-slate-500 opacity-0 transition-opacity duration-300");
                txt.setAttribute("id", `label-${edge.id}`);
                txt.textContent = edge.label;
                gLabels.appendChild(txt);
            });
        }

        // --- Animation Logic ---

        function resetAll() {
            clearTimeout(animTimer);
            state.isAnimating = false;
            state.stepIndex = 0;

            // Hide Backward
            document.querySelectorAll('.edge-backward').forEach(el => {
                el.style.opacity = '0';
                el.classList.remove('animate-draw');
            });
            document.querySelectorAll('#layer-labels-back text').forEach(el => el.style.opacity = '0');

            // Reset Equations
            document.getElementById('chain-equation').innerHTML = '<span class="text-slate-300 italic">Run backward pass to build equation...</span>';
            document.getElementById('chain-calc').innerHTML = '';

            // Reset Nodes
            document.querySelectorAll('.node-rect, .node-circle').forEach(el => el.style.filter = '');
        }

        function runForwardPass() {
            resetAll();
            // Simple visual cue for forward
            document.querySelectorAll('.edge-forward').forEach(el => {
                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 500);
            });
        }

        function runBackwardPass() {
            if (state.isAnimating) return;
            resetAll();
            state.isAnimating = true;
            state.stepIndex = 1; // Start at first step
            animateNextStep();
        }

        function stepAnimation() {
            if (state.stepIndex === 0) resetAll();
            state.stepIndex++;
            if (state.stepIndex >= STEPS.length) state.stepIndex = 1;
            executeStep(STEPS[state.stepIndex]);
        }

        function animateNextStep() {
            if (!state.isAnimating) return;

            if (state.stepIndex < STEPS.length) {
                executeStep(STEPS[state.stepIndex]);
                state.stepIndex++;
                animTimer = setTimeout(animateNextStep, 1000); // 1 sec per step
            } else {
                state.isAnimating = false;
            }
        }

        function executeStep(step) {
            if (!step) return;

            // 1. Activate Edge & Label
            if (step.id !== 'start' && step.id !== 'end') {
                const edge = document.getElementById(step.id);
                const label = document.getElementById(`label-${step.id}`);
                if (edge) {
                    edge.style.opacity = '1';
                    edge.classList.remove('animate-draw'); // reset
                    void edge.offsetWidth; // force reflow
                    edge.classList.add('animate-draw');
                }
                if (label) label.style.opacity = '1';

                // Highlight target node
                const edgeData = EDGES_BACK.find(e => e.id === step.id);
                if (edgeData) {
                    const nodeEl = document.querySelector(`#node-${edgeData.to} .node-rect`) || document.querySelector(`#node-${edgeData.to} .node-circle`);
                    if (nodeEl) nodeEl.classList.add('pulse-node');
                    setTimeout(() => nodeEl?.classList.remove('pulse-node'), 500);
                }
            }

            // 2. Build Equation
            if (step.eq) {
                const eqContainer = document.getElementById('chain-equation');
                if (eqContainer.innerHTML.includes('Run backward')) eqContainer.innerHTML = '';

                const span = document.createElement('span');
                span.innerHTML = step.eq;
                span.className = 'eq-term active ml-1';
                eqContainer.appendChild(span);

                updateChainCalc();
            }
        }

        function updateChainCalc() {
            const container = document.getElementById('chain-calc');
            const g = state.grads;

            // Build numeric string based on current progress
            // This assumes sequential order: Loss -> Act -> Pre -> W
            let text = "";
            const si = state.stepIndex; // 1-based index roughly

            if (document.getElementById('chain-equation').innerText.includes('∂L/∂a')) {
                text += `${g.dL_da.toFixed(3)}`;
            }
            if (document.getElementById('chain-equation').innerText.includes('da/dz')) {
                text += ` × ${g.da_dz.toFixed(3)}`;
            }
            if (document.getElementById('chain-equation').innerText.includes('∂z/∂u')) {
                text += ` × 1.0`;
            }
            if (document.getElementById('chain-equation').innerText.includes('∂u/∂w₁')) {
                text += ` × ${state.x1.toFixed(1)}`;
            }

            if (text) {
                // Calculate current running product
                let prod = 1;
                if (document.getElementById('chain-equation').innerText.includes('∂L/∂a')) prod *= g.dL_da;
                if (document.getElementById('chain-equation').innerText.includes('da/dz')) prod *= g.da_dz;
                if (document.getElementById('chain-equation').innerText.includes('∂u/∂w₁')) prod *= g.du_dw1;

                container.innerHTML = `${text} = <strong>${prod.toFixed(4)}</strong>`;
            }
        }

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('tooltip');
        const ttHeader = document.getElementById('tt-header');
        const ttSub = document.getElementById('tt-sub');
        const ttDesc = document.getElementById('tt-desc');

        const INFO = {
            loss: { h: "Loss Node", f: "L(a, y)", d: "Binary Cross-Entropy Loss. Measures error." },
            lossOp: { h: "Loss Function", f: "BCE", d: "Computes the difference between prediction and target." },
            y: { h: "Target", f: "Label", d: "The ground truth value (0 or 1)." },
            a: { h: "Activation", f: "σ(z)", d: "Sigmoid output. Probability between 0 and 1." },
            sig: { h: "Sigmoid", f: "1/(1+e⁻ᶻ)", d: "Squashing function." },
            z: { h: "Linear Sum", f: "u + b", d: "Pre-activation value." },
            add: { h: "Addition", f: "+", d: "Adds bias to the weighted input." },
            b: { h: "Bias", f: "Parameter", d: "Trainable offset. Gradient ∂L/∂b flows here." },
            u: { h: "Weighted Input", f: "w₁ · x₁", d: "Product of weight and input." },
            mul: { h: "Multiply", f: "×", d: "Scales input by weight." },
            w1: { h: "Weight", f: "Parameter", d: "Trainable scalar. Gradient ∂L/∂w₁ flows here." },
            x1: { h: "Input", f: "Feature", d: "Input data." }
        };

        function showTooltip(el, key) {
            const data = INFO[key];
            if (!data) return;

            ttHeader.textContent = data.h;
            ttSub.textContent = data.f;
            ttDesc.textContent = data.d;

            tooltip.style.opacity = '1';

            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const top = rect.top;

            tooltip.style.left = cx + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }

    </script>
</body>

</html>