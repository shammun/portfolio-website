<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top-k Sampling Visualization</title>
    <style>
        /* --- Clean Educational Style Guide & Variables --- */
        :root {
            /* Palette */
            --bg-page: #f5f7ff;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --text-label: #475569;
            
            /* Action Colors */
            --color-input: #f97316; /* Orange */
            --color-input-light: #ffedd5;
            --color-output: #14b8a6; /* Teal */
            --color-output-dark: #0f766e;
            --color-output-light: #ccfbf1;
            --color-filtered: #e2e8f0; /* Gray */
            --color-filtered-text: #94a3b8;
            --color-action: #8b5cf6; /* Purple */
            --color-action-hover: #7c3aed;
            --color-action-light: #f3f0ff;
            
            /* Dimensions & Spacing */
            --radius-lg: 16px;
            --radius-md: 8px;
            --radius-sm: 4px;
            --shadow-card: 0 4px 6px -1px rgba(139, 92, 246, 0.05), 0 2px 4px -1px rgba(139, 92, 246, 0.03);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --font-serif: Georgia, Cambria, "Times New Roman", Times, serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-page);
            color: var(--text-main);
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 30px;
        }

        /* --- Typography --- */
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
        h2 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sub); margin-bottom: 15px; }
        h3 { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        p { font-size: 14px; margin-bottom: 10px; color: var(--text-label); }
        
        .serif-italic { font-family: var(--font-serif); font-style: italic; }
        .math-lg { font-size: 1.2rem; }

        /* --- Controls Section --- */
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-filtered);
            flex-wrap: wrap;
            gap: 15px;
        }

        .slider-container {
            flex: 1;
            min-width: 300px;
            background: var(--color-action-light);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid #ddd6fe;
        }

        .slider-label-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .k-value-display {
            color: var(--color-action);
            font-size: 1.2rem;
            font-weight: bold;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--color-action);
        }

        .slider-annotations {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 5px;
        }

        /* --- Navigation & Progress --- */
        .step-nav-container {
            margin-bottom: 20px;
            background: #f8fafc;
            padding: 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-filtered);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .progress-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .progress-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--color-filtered);
            color: var(--text-sub);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-dot.active {
            background: var(--color-action);
            color: white;
            transform: scale(1.1);
        }

        .nav-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .btn-nav {
            background: white;
            border: 1px solid var(--color-filtered);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-nav:hover:not(:disabled) {
            background: var(--color-action-light);
            border-color: var(--color-action);
            color: var(--color-action);
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-play {
            background: var(--color-action);
            color: white;
            border: none;
            padding: 8px 24px;
            font-weight: bold;
        }
        .btn-play:hover { background: var(--color-action-hover); }

        .btn-code-toggle {
            margin-left: auto; /* Push to right */
            font-size: 12px;
            color: var(--color-action);
            border-color: var(--color-action);
        }

        /* --- Visualization Steps (Carousel Flow) --- */
        .vis-pipeline {
            position: relative;
            min-height: 400px; /* Pre-allocate height to prevent jumps */
            overflow: hidden;
        }

        .step-card {
            background: #fff;
            border: 1px solid var(--color-filtered);
            border-radius: var(--radius-md);
            padding: 20px;
            position: absolute;
            top: 0; left: 0; right: 0;
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }

        .step-card.active {
            position: relative; /* Relative ensures it takes up space in flow */
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .step-badge {
            background: var(--color-action);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 700;
            margin-right: 10px;
        }

        /* Chart Styles */
        .chart-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 250px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            height: 28px;
            gap: 10px;
            transition: all 0.4s ease-in-out;
        }

        .bar-label {
            width: 60px;
            text-align: right;
            font-size: 12px;
            font-family: var(--font-mono);
            color: var(--text-main);
        }

        .bar-track {
            flex: 1;
            background: #f8fafc;
            height: 100%;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            min-width: 2px;
        }

        .bar-value {
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        /* Specific State Colors */
        .input-bar { background-color: var(--color-input); }
        .selected-bar { background-color: var(--color-output); }
        .filtered-bar { background-color: var(--color-filtered); }
        
        .masked-box {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 11px;
            width: 100%;
            text-align: center;
        }
        .masked-val-active { background: var(--color-output-light); color: var(--color-output-dark); border: 1px solid var(--color-output); }
        .masked-val-inactive { background: var(--color-filtered); color: var(--text-sub); border: 1px solid #cbd5e1; }

        .threshold-line {
            height: 2px;
            background: var(--color-action);
            margin: 5px 0 5px 70px; /* Align with bars */
            position: relative;
            border-top: 1px dashed var(--color-action);
            opacity: 0.6;
            display: flex;
            align-items: center;
            transition: top 0.3s;
        }
        .threshold-label {
            position: absolute;
            right: 0;
            background: var(--color-action);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            top: -10px;
        }

        /* --- Comparison Panel --- */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .comparison-card {
            background: white;
            border: 1px solid var(--color-filtered);
            border-radius: var(--radius-md);
            padding: 15px;
            border-left: 4px solid var(--color-filtered);
        }

        .comparison-card.active-range {
            border-left-color: var(--color-action);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
            background: var(--color-action-light);
        }

        .sample-text {
            font-family: var(--font-serif);
            font-style: italic;
            color: var(--text-main);
            margin-top: 5px;
            line-height: 1.4;
        }

        /* --- Sampling Demo --- */
        .sampling-section {
            margin-top: 40px;
            background: linear-gradient(to right, #f0fdfa, #f5f3ff);
            border: 1px solid #ccfbf1;
            padding: 25px;
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .btn-generate {
            background: linear-gradient(to right, var(--color-output), #0d9488);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(20, 184, 166, 0.3);
            transition: transform 0.1s;
            margin-bottom: 15px;
        }
        
        .btn-generate:active { transform: scale(0.98); }

        .generated-output-box {
            background: white;
            border: 2px solid var(--color-filtered);
            border-radius: var(--radius-md);
            min-height: 60px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }

        .gen-token {
            padding: 2px 6px;
            border-radius: 4px;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- Footer / Educational --- */
        .footer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .key-takeaway {
            background: var(--color-action-light);
            border: 2px solid #c4b5fd;
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .math-panel {
            background: #fff;
            border: 1px solid var(--color-filtered);
            border-radius: var(--radius-md);
            padding: 20px;
        }
        
        .math-step { margin-bottom: 8px; font-size: 13px; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.open { opacity: 1; pointer-events: all; }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-filtered);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 0;
            overflow-y: auto;
            background: #1e293b; /* Dark theme for code */
            color: #e2e8f0;
            font-family: var(--font-mono);
            font-size: 13px;
        }

        .code-block {
            counter-reset: line;
            padding: 20px 0;
        }

        .code-line {
            display: block;
            padding: 4px 20px;
            position: relative;
            line-height: 1.6;
            white-space: pre; 
            transition: opacity 0.3s, background 0.3s;
        }

        .code-line::before {
            counter-increment: line;
            content: counter(line);
            display: inline-block;
            width: 30px;
            color: #64748b;
            text-align: right;
            margin-right: 15px;
            user-select: none;
        }

        /* Focus mode styles */
        .code-line.dimmed { opacity: 0.6; } /* Increased opacity for better readability */
        .code-line.highlighted { 
            background: rgba(139, 92, 246, 0.15); 
            border-left: 4px solid var(--color-action);
            opacity: 1;
        }

        /* Syntax Highlighting */
        .token-kw { color: #c084fc; } /* purple */
        .token-fn { color: #60a5fa; } /* blue */
        .token-str { color: #86efac; } /* green */
        .token-com { color: #94a3b8; font-style: italic; } /* gray */
        .token-num { color: #fca5a5; } /* red */

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-sub);
            padding: 0 8px;
        }

        .btn-copy {
            background: var(--color-action-light);
            color: var(--color-action);
            border: 1px solid var(--color-action);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 10px;
        }
        .btn-copy:hover {
            background: var(--color-action);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .footer-grid, .comparison-grid { grid-template-columns: 1fr; }
            .bar-label { width: 50px; }
            .threshold-label { display: none; }
            .nav-controls { flex-wrap: wrap; }
            .btn-code-toggle { margin-left: 0; width: 100%; justify-content: center;}
        }
        
        /* Tooltip */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #334155;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Top-k Sampling Visualizer</h1>
    <p>Interactive demonstration of how LLMs balance coherence and diversity by filtering the vocabulary.</p>

    <!-- Controls -->
    <div class="controls-header">
        <div class="slider-container">
            <div class="slider-label-row">
                <span>Select k Value</span>
                <span class="k-value-display" id="kDisplay">k = 3</span>
            </div>
            <input type="range" id="kSlider" min="1" max="9" value="3" step="1" aria-label="K Value Slider" aria-valuenow="3">
            <div class="slider-annotations">
                <span>1 (Greedy)</span>
                <span>Balanced</span>
                <span>9 (All)</span>
            </div>
            <p id="kDescription" style="margin-top: 10px; font-size: 13px; color: var(--color-action);">
                Typical range for balanced generation.
            </p>
        </div>
    </div>

    <!-- Step Navigation -->
    <div class="step-nav-container">
        <!-- Progress Dots -->
        <div class="progress-indicators">
            <div class="progress-dot active" onclick="goToStep(0)">1</div>
            <div class="progress-dot" onclick="goToStep(1)">2</div>
            <div class="progress-dot" onclick="goToStep(2)">3</div>
            <div class="progress-dot" onclick="goToStep(3)">4</div>
        </div>

        <!-- Buttons -->
        <div class="nav-controls">
            <button class="btn-nav" id="btnPrev" onclick="prevStep()">← Prev</button>
            <button class="btn-nav btn-play" id="btnPlay" onclick="togglePlay()">
                <span id="playIcon">▶</span> <span id="playText">Auto Play</span>
            </button>
            <button class="btn-nav" id="btnNext" onclick="nextStep()">Next →</button>
            
            <button class="btn-nav btn-code-toggle" id="btnShowCode" onclick="showCurrentStepCode()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                Show Code for Step <span id="codeStepNum">1</span>
            </button>
        </div>
    </div>

    <!-- Main Visual Pipeline (Carousel) -->
    <div class="vis-pipeline">
        
        <!-- Step 1: Input Logits -->
        <div class="step-card active" id="step1">
            <div class="step-header">
                <h3><span class="step-badge">STEP 1</span>Input: Raw Logits</h3>
                <span style="font-size: 12px; color: var(--text-sub);">Output from Model</span>
            </div>
            <div class="chart-container" id="chart-logits">
                <!-- Bars generated by JS -->
            </div>
        </div>

        <!-- Step 2: Sort & Select -->
        <div class="step-card" id="step2">
            <div class="step-header">
                <h3><span class="step-badge">STEP 2</span>Process: Sort & Select Top-k</h3>
                <span style="font-size: 12px; color: var(--text-sub);">Filter Logic</span>
            </div>
            <div class="chart-container" id="chart-sorted">
                <!-- Sorted Bars generated by JS -->
            </div>
        </div>

        <!-- Step 3: Masking -->
        <div class="step-card" id="step3">
            <div class="step-header">
                <h3><span class="step-badge">STEP 3</span>Process: Mask Non-Top-k</h3>
                <span style="font-size: 12px; color: var(--text-sub);">Apply -∞</span>
            </div>
            <p style="font-size: 13px; margin-bottom: 15px;">We return to the original vocabulary order. Filtered tokens are set to negative infinity.</p>
            <div class="chart-container" id="chart-masked">
                <!-- Masked Values generated by JS -->
            </div>
        </div>

        <!-- Step 4: Softmax -->
        <div class="step-card" id="step4">
            <div class="step-header">
                <h3><span class="step-badge">STEP 4</span>Output: Renormalized Probabilities</h3>
                <span style="font-size: 12px; color: var(--text-sub);">Softmax Result</span>
            </div>
            <div class="chart-container" id="chart-probs">
                <!-- Prob Bars generated by JS -->
            </div>
            <div style="text-align: right; font-size: 11px; color: var(--color-output-dark); margin-top: 5px;">
                Sum of Probabilities: <span id="probSum">1.00</span>
            </div>
        </div>

    </div>

    <!-- Comparison Panel -->
    <div class="comparison-grid">
        <div class="comparison-card" id="compLow">
            <h3>Low k (1-3)</h3>
            <div style="font-size: 12px; font-weight: bold; color: var(--color-action);">High Coherence, Low Diversity</div>
            <p class="sample-text">"The cat sat on the mat and looked around carefully."</p>
        </div>
        <div class="comparison-card" id="compHigh">
            <h3>High k (5+)</h3>
            <div style="font-size: 12px; font-weight: bold; color: var(--color-action);">High Diversity, Lower Coherence</div>
            <p class="sample-text">"The cat perched lounged rested situated positioned..."</p>
        </div>
    </div>

    <!-- Sampling Demo -->
    <div class="sampling-section">
        <h3>Real-time Sampling Demo</h3>
        <p style="margin-bottom: 20px;">Click generate to pick a next token based on the probabilities in Step 4.</p>
        <button class="btn-generate" id="btnGenerate" onclick="generateToken()">Generate Token</button>
        <div class="generated-output-box" id="generatedText">
            <span style="color: #94a3b8; font-style: italic;">Generated text will appear here...</span>
        </div>
    </div>

    <!-- Educational Footer -->
    <div class="footer-grid">
        <div class="key-takeaway">
            <h4 style="color: var(--color-action); margin-bottom: 10px;">Key Takeaway</h4>
            <ul style="font-size: 14px; padding-left: 20px; line-height: 1.6; color: var(--text-main);">
                <li><strong>Small k:</strong> Limits choices to only the most likely words. Safe, but repetitive.</li>
                <li><strong>Large k:</strong> Allows more creative words, but risks grammar mistakes or nonsense.</li>
                <li><strong>The Trick:</strong> Masking with <span class="serif-italic">-∞</span> ensures the probability becomes exactly 0.0 after Softmax.</li>
            </ul>
        </div>
        
        <div class="math-panel">
            <h4 style="color: var(--text-sub); margin-bottom: 10px;">THE MATH BEHIND IT</h4>
            <div class="math-step">
                <strong>1. Filter:</strong> Let <span class="serif-italic">threshold</span> = <span class="serif-italic">sorted_logits[k]</span>
            </div>
            <div class="math-step">
                <strong>2. Mask:</strong> 
                <span class="serif-italic">z'<sub>i</sub></span> = 
                <span class="serif-italic">z<sub>i</sub></span> if <span class="serif-italic">z<sub>i</sub></span> ≥ threshold else <span class="serif-italic">-∞</span>
            </div>
            <div class="math-step">
                <strong>3. Softmax:</strong>
                <span class="serif-italic">P(x<sub>i</sub>)</span> = 
                <span class="math-lg">e</span><sup>z'<sub>i</sub></sup> / Σ <span class="math-lg">e</span><sup>z'<sub>j</sub></sup>
            </div>
            <div style="font-size: 12px; color: var(--text-sub); margin-top: 5px;">
                Note: <span class="serif-italic">e<sup>-∞</sup></span> is 0, effectively removing the token.
            </div>
        </div>
    </div>
</div>

<!-- Code Modal -->
<div class="modal-overlay" id="codeModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>PyTorch Implementation</h3>
            <div style="display: flex; align-items: center;">
                <button class="btn-copy" onclick="copyCode()">Copy Code</button>
                <button class="close-btn" onclick="closeModalDirect()">×</button>
            </div>
        </div>
        <div class="modal-body" id="codeBody">
            <!-- Code injected by JS -->
        </div>
    </div>
</div>

<script>
    // --- Data & State ---
    const vocabulary = ["closer", "every", "effort", "forward", "inches", "moves", "pizza", "toward", "you"];
    const rawLogits = [4.51, 0.89, -1.90, 6.75, 1.63, -1.62, -1.89, 6.28, 1.79];
    
    let data = vocabulary.map((token, i) => ({
        id: i,
        token: token,
        logit: rawLogits[i],
        color: 'var(--color-input)'
    }));

    // State
    let k = 3;
    let currentProbs = [];
    let generatedTokens = [];
    let currentStepIndex = 0; // 0=Logits, 1=Sort, 2=Mask, 3=Softmax
    let isPlaying = false;
    let playInterval = null;

    // --- DOM Elements ---
    const chartLogits = document.getElementById('chart-logits');
    const chartSorted = document.getElementById('chart-sorted');
    const chartMasked = document.getElementById('chart-masked');
    const chartProbs = document.getElementById('chart-probs');
    const kSlider = document.getElementById('kSlider');
    const kDisplay = document.getElementById('kDisplay');
    const kDesc = document.getElementById('kDescription');
    const generatedTextContainer = document.getElementById('generatedText');
    
    // Step Elements
    const stepCards = [
        document.getElementById('step1'),
        document.getElementById('step2'),
        document.getElementById('step3'),
        document.getElementById('step4')
    ];
    const progressDots = document.querySelectorAll('.progress-dot');
    const btnShowCode = document.getElementById('btnShowCode');
    const codeStepNum = document.getElementById('codeStepNum');

    // --- Core Math Functions ---

    function softmax(logits) {
        const maxLogit = Math.max(...logits);
        const exps = logits.map(l => Math.exp(l - maxLogit)); 
        const sumExps = exps.reduce((a, b) => a + b, 0);
        return exps.map(e => e / sumExps);
    }

    function updateLogic() {
        const sortedData = [...data].sort((a, b) => b.logit - a.logit);
        const topK = sortedData.slice(0, k);
        const threshold = topK[topK.length - 1].logit;
        const topKIds = new Set(topK.map(d => d.id));
        const maskedLogits = data.map(d => topKIds.has(d.id) ? d.logit : -Infinity);
        const activeLogits = maskedLogits.map(l => l === -Infinity ? -1000 : l);
        const probabilities = softmax(activeLogits);
        currentProbs = probabilities.map((p, i) => topKIds.has(data[i].id) ? p : 0);

        renderAll(sortedData, topKIds, maskedLogits);
        updateComparison();
    }

    // --- Rendering Functions ---

    function createBar(label, value, maxVal, color, displayValue, tooltip) {
        const percent = Math.max((value / maxVal) * 100, 0); 
        let width = 0;
        if(displayValue.includes("Logit")) {
             width = ((value + 3) / 10) * 100; 
             width = Math.min(Math.max(width, 2), 100);
        } else {
             width = (value / maxVal) * 100;
        }

        return `
            <div class="bar-row" data-tooltip="${tooltip}">
                <div class="bar-label">${label}</div>
                <div class="bar-track">
                    <div class="bar-fill" style="width: ${width}%; background-color: ${color};">
                        <span class="bar-value">${typeof value === 'number' && !displayValue.includes("inf") ? value.toFixed(2) : ''}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function renderAll(sortedData, topKIds, maskedLogits) {
        // Step 1
        chartLogits.innerHTML = data.map(d => 
            createBar(d.token, d.logit, 7, 'var(--color-input)', `Logit: ${d.logit}`, `Raw Logit: ${d.logit}`)
        ).join('');

        // Step 2
        chartSorted.innerHTML = sortedData.map((d, i) => {
            const isSelected = i < k;
            const color = isSelected ? 'var(--color-output)' : 'var(--color-filtered)';
            let html = createBar(d.token, d.logit, 7, color, `Logit`, isSelected ? "Selected" : "Filtered Out");
            if (i === k - 1) {
                html += `<div class="threshold-line"><div class="threshold-label">Cutoff (k=${k})</div></div>`;
            }
            return html;
        }).join('');

        // Step 3
        chartMasked.innerHTML = data.map((d, i) => {
            const isKept = topKIds.has(d.id);
            const valClass = isKept ? 'masked-val-active' : 'masked-val-inactive';
            const valText = isKept ? d.logit.toFixed(2) : '-inf';
            const bg = isKept ? 'white' : 'var(--color-filtered)';
            return `
            <div class="bar-row">
                <div class="bar-label">${d.token}</div>
                <div style="flex:1; display: flex; align-items: center; background: ${bg}; border-radius:4px; padding: 0 10px;">
                    <div class="masked-box ${valClass}">
                        ${valText}
                    </div>
                </div>
            </div>`;
        }).join('');

        // Step 4
        chartProbs.innerHTML = currentProbs.map((p, i) => {
            const token = data[i].token;
            const isZero = p === 0;
            const color = isZero ? 'var(--color-filtered)' : 'var(--color-output)';
            const tooltip = isZero ? "Probability: 0.0 (Masked)" : `Probability: ${p.toFixed(3)}`;
            return createBar(token, p, 1, color, "Prob", tooltip);
        }).join('');
    }

    function updateComparison() {
        const compLow = document.getElementById('compLow');
        const compHigh = document.getElementById('compHigh');
        
        compLow.classList.remove('active-range');
        compHigh.classList.remove('active-range');

        if (k <= 3) {
            compLow.classList.add('active-range');
            kDesc.textContent = "Low k: High Coherence, Low Diversity. Risk of repetition.";
        } else if (k >= 8) {
            compHigh.classList.add('active-range');
            kDesc.textContent = "High k: High Diversity. Risk of incoherence.";
        } else {
            compLow.classList.add('active-range');
            compHigh.classList.add('active-range');
            kDesc.textContent = "Balanced Range: Good mix of coherence and creativity.";
        }

        if(k==1) kDisplay.innerHTML = `k = 1 <small>(Greedy)</small>`;
        else if(k==9) kDisplay.innerHTML = `k = 9 <small>(All)</small>`;
        else kDisplay.textContent = `k = ${k}`;
    }

    // --- Step Navigation Logic ---

    function updateStepView() {
        // Hide all cards
        stepCards.forEach(card => card.classList.remove('active'));
        progressDots.forEach(dot => dot.classList.remove('active'));

        // Show active
        stepCards[currentStepIndex].classList.add('active');
        progressDots[currentStepIndex].classList.add('active');

        // Update Buttons
        document.getElementById('btnPrev').disabled = (currentStepIndex === 0);
        document.getElementById('btnNext').textContent = (currentStepIndex === 3) ? "Restart ↻" : "Next →";

        // Update Code Button Text
        codeStepNum.textContent = currentStepIndex + 1;
    }

    function nextStep() {
        if (currentStepIndex < 3) {
            currentStepIndex++;
        } else {
            currentStepIndex = 0; // Loop or stop? Let's loop.
        }
        updateStepView();
    }

    function prevStep() {
        if (currentStepIndex > 0) {
            currentStepIndex--;
            updateStepView();
        }
    }

    function goToStep(idx) {
        currentStepIndex = idx;
        updateStepView();
        if(isPlaying) togglePlay(); // stop auto play if manual interaction
    }

    function togglePlay() {
        isPlaying = !isPlaying;
        const btn = document.getElementById('btnPlay');
        const icon = document.getElementById('playIcon');
        const text = document.getElementById('playText');

        if (isPlaying) {
            btn.style.background = '#ef4444'; // Red for stop
            icon.textContent = '⏸';
            text.textContent = 'Pause';
            playInterval = setInterval(nextStep, 2500); // 2.5s per step
        } else {
            btn.style.background = ''; // Default
            icon.textContent = '▶';
            text.textContent = 'Auto Play';
            clearInterval(playInterval);
        }
    }

    // --- Sampling Demo Logic ---

    function generateToken() {
        const r = Math.random();
        let cumulative = 0;
        let selectedIndex = -1;

        for (let i = 0; i < currentProbs.length; i++) {
            cumulative += currentProbs[i];
            if (r <= cumulative) {
                selectedIndex = i;
                break;
            }
        }
        
        if (selectedIndex === -1) selectedIndex = currentProbs.length - 1; 

        const tokenObj = data[selectedIndex];
        
        if(generatedTokens.length === 0) generatedTextContainer.innerHTML = '';
        
        const span = document.createElement('span');
        span.className = 'gen-token';
        span.textContent = tokenObj.token;
        const prob = currentProbs[selectedIndex];
        if (prob > 0.5) {
            span.style.background = 'var(--color-output-dark)';
            span.style.color = 'white';
        } else {
            span.style.background = 'var(--color-output-light)';
            span.style.color = 'var(--color-output-dark)';
        }
        
        generatedTextContainer.appendChild(span);
        generatedTokens.push(tokenObj.token);
    }

    kSlider.addEventListener('input', (e) => {
        k = parseInt(e.target.value);
        updateLogic();
    });

    // --- Modal & Code Logic ---
    
    const pyCode = `
# 1. Get raw model outputs
logits = model(context)

def select_top_k(logits, k):
    """
    Select top k logits and mask others with -inf
    """
    # 2. Sort and get the k-th largest value
    top_k_values, top_k_indices = torch.topk(logits, k)
    top_k_min = top_k_values[:, -1]  # The smallest of the top-k
    
    # 3. Create mask: keep values >= k-th largest
    masked_logits = torch.where(
        logits >= top_k_min,
        logits,
        torch.tensor(float('-inf'))
    )
    
    return masked_logits

def generate_step(logits, k, temperature=1.0):
    logits = logits / temperature
    filtered_logits = select_top_k(logits, k)
    
    # 4. Apply softmax to get probabilities
    probs = torch.softmax(filtered_logits, dim=-1)
    
    next_token = torch.multinomial(probs, num_samples=1)
    return next_token
`;

    function stripCommonIndent(str) {
        const lines = str.split('\n');
        const firstCodeLine = lines.find(l => l.trim().length > 0);
        if (!firstCodeLine) return str;
        const indent = firstCodeLine.match(/^\s*/)[0];
        if (!indent) return str;
        return lines.map(line => {
            if (line.startsWith(indent)) {
                return line.substring(indent.length);
            }
            return line;
        }).join('\n');
    }

    function highlightCode(code) {
        code = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const tokenRegex = /((?:#.*))|((?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'))|(\b(?:def|return|import|if|else|elif|for|while|try|except|with|as)\b)|(\b[a-zA-Z_]\w*(?=\())|(\b-?inf\b|\b\d+\.?\d*\b)/g;
        return code.replace(tokenRegex, (match, com, str, kw, fn, num) => {
            if (com) return `<span class="token-com">${com}</span>`;
            if (str) return `<span class="token-str">${str}</span>`;
            if (kw) return `<span class="token-kw">${kw}</span>`;
            if (fn) return `<span class="token-fn">${fn}</span>`;
            if (num) return `<span class="token-num">${num}</span>`;
            return match;
        });
    }

    function renderCodeForStep(stepIdx) {
        const cleanCode = stripCommonIndent(pyCode).trim();
        const codeLines = cleanCode.split('\n');
        
        const codeHtml = codeLines.map((line, idx) => {
            let activeClass = 'dimmed'; // Default to dim
            
            // Logic to determine which lines belong to which step
            // Step 1: Logits
            if (stepIdx === 0 && (line.includes('logits = model') || line.includes('# 1.'))) {
                activeClass = 'highlighted';
            }
            // Step 2: Sort
            else if (stepIdx === 1 && (line.includes('top_k') || line.includes('# 2.'))) {
                activeClass = 'highlighted';
            }
            // Step 3: Mask
            else if (stepIdx === 2 && (line.includes('torch.where') || line.includes('-inf') || line.includes('masked_logits') || line.includes('# 3.'))) {
                activeClass = 'highlighted';
            }
            // Step 4: Softmax
            else if (stepIdx === 3 && (line.includes('torch.softmax') || line.includes('probs =') || line.includes('# 4.'))) {
                activeClass = 'highlighted';
            }
            // Keep function definitions visible but not highlighted as primary action? 
            // Or just dim everything else to focus user attention? 
            // Decision: Dim everything else strongly.

            const content = highlightCode(line);
            return `<span class="code-line ${activeClass}">${content}</span>`;
        }).join('');
        
        document.getElementById('codeBody').innerHTML = `<div class="code-block">${codeHtml}</div>`;
        
        // Auto scroll to highlighted part
        setTimeout(() => {
            const el = document.querySelector('.code-line.highlighted');
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    function showCurrentStepCode() {
        renderCodeForStep(currentStepIndex);
        document.getElementById('codeModal').classList.add('open');
    }

    function closeModalDirect() {
        document.getElementById('codeModal').classList.remove('open');
    }

    function closeModal(e) {
        if(e.target.id === 'codeModal') {
            closeModalDirect();
        }
    }

    function copyCode() {
        // Create a temporary textarea to handle the copy
        const el = document.createElement('textarea');
        // Get clean code without extra indentation
        el.value = stripCommonIndent(pyCode).trim();
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy'); // Support for iframe environments
        document.body.removeChild(el);

        // Visual Feedback
        const btn = document.querySelector('.btn-copy');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = 'var(--color-output)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--color-output)';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.style.color = '';
            btn.style.borderColor = '';
        }, 2000);
    }

    // --- Init ---
    updateLogic();
    updateStepView();

</script>

</body>
</html>